<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Música Web</title>
    <!-- PWA Manifest & Meta Tags -->
    <meta name="theme-color" content="#1a202c"/>
    <link rel="manifest" id="manifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Music Player">

    <!-- Tailwind CSS para un diseño rápido y moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca para leer metadatos de archivos de audio (ID3 tags) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <!-- Google Fonts: Inter & Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- ColorThief for dynamic colors -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <!-- SortableJS for queue management -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* MD3 Inspired Color Palette & Base Styles */
        :root {
            --md-primary: #3b82f6; /* blue-500 */
            --md-on-primary: #ffffff;
            --md-primary-container: #dbeafe; /* blue-100 */
            --md-on-primary-container: #1e40af; /* blue-800 */
            --md-secondary: #16a34a; /* green-600 */
            --md-on-secondary: #ffffff;
            --md-secondary-container: #dcfce7; /* green-100 */
            --md-on-secondary-container: #166534; /* green-800 */
            --md-surface-1: #ffffff;
            --md-surface-2: #f8fafc; /* slate-50 */
            --md-surface-3: #f1f5f9; /* slate-100 */
            --md-on-surface: #1e293b; /* slate-800 */
            --md-surface-variant: #e2e8f0; /* slate-200 */
            --md-on-surface-variant: #475569; /* slate-600 */
            --md-outline: #cbd5e1; /* slate-300 */
            --md-scrim: rgba(0,0,0,0.6);
            --dynamic-accent-color: var(--md-primary); /* Default accent color */
        }
        html.dark {
            --md-primary: #60a5fa; /* blue-400 */
            --md-on-primary: #0c2f66;
            --md-primary-container: #1e3a8a; /* blue-900 */
            --md-on-primary-container: #bfdbfe; /* blue-200 */
            --md-secondary: #4ade80; /* green-400 */
            --md-on-secondary: #052e16;
            --md-secondary-container: #166534; /* green-800 */
            --md-on-secondary-container: #bbf7d0; /* green-200 */
            --md-surface-1: #0f172a; /* slate-900 */
            --md-surface-2: #1e293b; /* slate-800 */
            --md-surface-3: #334155; /* slate-700 */
            --md-on-surface: #e2e8f0; /* slate-200 */
            --md-surface-variant: #475569; /* slate-600 */
            --md-on-surface-variant: #94a3b8; /* slate-400 */
            --md-outline: #475569; /* slate-600 */
        }
        body {
            background-color: var(--md-surface-2);
            color: var(--md-on-surface);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--md-surface-variant); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--md-on-surface-variant); }
        .progress-bar-container:hover .progress-bar-thumb { opacity: 1; }
        
        /* Material Symbols base style */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
            transition: font-variation-settings 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        /* Karaoke Styles */
        .karaoke-view {
            background-color: rgba(26, 32, 44, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .lyrics-container {
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 25%, black 75%, transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 25%, black 75%, transparent 100%);
            padding: 50vh 0;
        }
        .lyric-line {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.5; color: #a0aec0; transform: scale(0.95);
            padding: 0.5rem 1rem; margin: 0.25rem 0; border-radius: 1rem;
        }
        .lyric-line.active {
            opacity: 1; color: #ffffff; transform: scale(1.05);
            background-color: rgba(74, 85, 104, 0.3);
        }
        .lyric-line.past { opacity: 0.3; transform: scale(0.9); }
        .lyric-line.active > span {
            background: linear-gradient(to right, var(--md-primary) var(--word-progress, 0%), #ffffff var(--word-progress, 0%));
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        .task-item.completed label {
            text-decoration: line-through;
            color: var(--md-on-surface-variant);
        }

        /* Now Playing View Styles */
        #now-playing-view {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            background-color: rgba(0,0,0,0.7); /* Fallback */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        #now-playing-bg {
            background-size: cover;
            background-position: center;
            filter: blur(30px) brightness(0.5); /* Increase blur and darkness */
            transform: scale(1.2); /* Avoid edges showing due to blur */
            transition: background-image 0.5s ease-in-out;
            background-image: linear-gradient(to bottom, var(--dynamic-accent-color), var(--md-surface-1)); /* Apply dynamic color */
        }
        #now-playing-view .progress-bar-thumb { opacity: 1; } /* Always show thumb */
        /* Use dynamic color for active elements */
        #now-playing-view #np-progress-bar,
        #now-playing-view .progress-bar-thumb {
            background-color: var(--dynamic-accent-color);
        }
        #now-playing-view button.active-control { /* Class for active shuffle/repeat */
             color: var(--dynamic-accent-color);
             background-color: rgba(255, 255, 255, 0.15);
        }
        #now-playing-view #np-play-pause-btn {
            color: var(--dynamic-accent-color); /* Make play button dynamic */
        }

        #queue-panel {
            transition: transform 0.3s ease-in-out;
        }
        #queue-list li.playing {
            background-color: var(--md-primary-container);
            color: var(--md-on-primary-container);
            font-weight: 600;
        }
        #queue-list li.playing img {
            opacity: 0.7;
        }
        /* Style for drag handle */
        .drag-handle { cursor: grab; }
        .sortable-ghost { opacity: 0.4; background-color: var(--md-surface-variant); }
        .sortable-chosen { background-color: var(--md-surface-variant); }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app-container">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>

        <div class="flex flex-col h-screen">
            <div class="relative flex flex-1 overflow-hidden">
                <!-- Barra Lateral (Sidebar) -->
                <nav id="sidebar" class="absolute z-30 top-0 left-0 h-full w-64 bg-[var(--md-surface-3)] p-4 flex flex-col shrink-0 -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out">
                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center space-x-2">
                             <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                             <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                             <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        </div>
                        <!-- User Info Placeholder -->
                        <div id="user-info" class="text-xs text-right text-[var(--md-on-surface-variant)] truncate"></div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto -mx-4">
                        <div class="px-4">
                            <h2 class="text-xs font-semibold text-[var(--md-on-surface-variant)] uppercase tracking-wider mb-2">Biblioteca</h2>
                            <ul id="nav-links" class="space-y-1">
                                <li><a href="#" data-view="songs" class="nav-link flex items-center p-2 rounded-full"><span class="material-symbols-outlined mr-3">music_note</span>Canciones</a></li>
                                <li><a href="#" data-view="albums" class="nav-link flex items-center p-2 rounded-full"><span class="material-symbols-outlined mr-3">album</span>Álbumes</a></li>
                                <li><a href="#" data-view="artists" class="nav-link flex items-center p-2 rounded-full"><span class="material-symbols-outlined mr-3">mic</span>Artistas</a></li>
                                <li><a href="#" data-view="playlists" class="nav-link flex items-center p-2 rounded-full"><span class="material-symbols-outlined mr-3">queue_music</span>Playlists</a></li>
                                <li><a href="#" data-view="history" class="nav-link flex items-center p-2 rounded-full"><span class="material-symbols-outlined mr-3">calendar_month</span>Calendario</a></li>
                                <li class="pt-2"><div class="border-t border-[var(--md-outline)] my-2"></div></li>
                                <li><a href="#" data-view="videos" class="nav-link flex items-center p-2 rounded-full"><span class="material-symbols-outlined mr-3">movie</span>Vídeos</a></li>
                                <li><a href="#" data-view="images" class="nav-link flex items-center p-2 rounded-full"><span class="material-symbols-outlined mr-3">photo_library</span>Imágenes</a></li>
                            </ul>
                            
                            <div class="mt-6 pt-4 border-t border-[var(--md-outline)]">
                                <h2 class="text-xs font-semibold text-[var(--md-on-surface-variant)] uppercase tracking-wider mb-2">Carpetas</h2>
                                <ul id="folder-list" class="space-y-1"></ul>
                                <label for="add-folder-input" class="mt-2 w-full flex items-center justify-center p-2 rounded-full bg-[var(--md-surface-variant)] hover:bg-[var(--md-on-surface-variant)]/20 transition-colors cursor-pointer">
                                    <span class="material-symbols-outlined mr-2">add</span>
                                    Añadir Carpeta
                                </label>
                                <input type="file" id="add-folder-input" webkitdirectory directory multiple class="hidden">
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto pt-4 space-y-2">
                         <button id="sign-in-btn" class="w-full flex items-center justify-center p-2 rounded-full bg-[var(--md-primary-container)] text-[var(--md-on-primary-container)] hover:opacity-90 transition-colors font-semibold">
                            <span class="material-symbols-outlined mr-2">login</span>
                            Iniciar Sesión (Google)
                        </button>
                         <button id="sign-out-btn" class="w-full hidden items-center justify-center p-2 rounded-full bg-[var(--md-surface-variant)] hover:bg-[var(--md-on-surface-variant)]/20 transition-colors">
                            <span class="material-symbols-outlined mr-2">logout</span>
                            Cerrar Sesión
                        </button>
                        <button id="theme-btn" class="w-full flex items-center justify-center p-2 rounded-full bg-[var(--md-surface-variant)] hover:bg-[var(--md-on-surface-variant)]/20 transition-colors">
                            <span class="material-symbols-outlined mr-2">palette</span>
                            Personalizar
                        </button>
                    </div>
                </nav>

                <!-- Contenido Principal -->
                <main class="flex-1 flex flex-col bg-[var(--md-surface-1)]">
                    <header id="main-header" class="p-4 border-b border-[var(--md-outline)] shrink-0 flex items-center">
                        <button id="menu-btn" class="md:hidden p-2 rounded-full hover:bg-[var(--md-surface-variant)] mr-2 -ml-2">
                            <span class="material-symbols-outlined">menu</span>
                        </button>
                        <h1 id="header-title" class="text-2xl font-bold truncate">Canciones</h1>
                        <div class="relative ml-auto">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[var(--md-on-surface-variant)]">search</span>
                            <input type="search" id="search-input" placeholder="Buscar..." class="bg-[var(--md-surface-variant)] rounded-full pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--md-primary)] w-32 md:w-64 transition-all duration-300">
                        </div>
                    </header>
                    
                    <div id="main-content" class="flex-1 overflow-y-auto p-4">
                        <div id="initial-prompt" class="flex flex-col items-center justify-center h-full text-center text-[var(--md-on-surface-variant)] p-4">
                            <span class="material-symbols-outlined text-7xl mb-4">create_new_folder</span>
                            <h2 class="text-xl font-semibold mb-2 text-[var(--md-on-surface)]">Tu biblioteca está vacía</h2>
                            <p class="mb-4">Selecciona una carpeta con tu música para empezar.</p>
                            <label for="folder-input" class="cursor-pointer bg-[var(--md-primary)] text-[var(--md-on-primary)] font-semibold px-6 py-3 rounded-full hover:opacity-90 transition-opacity">
                                Seleccionar Carpeta
                            </label>
                            <input type="file" id="folder-input" webkitdirectory directory multiple class="hidden">
                        </div>
                        <div id="loading-state" class="hidden flex-col items-center justify-center h-full text-center text-[var(--md-on-surface-variant)]">
                            <svg class="animate-spin h-10 w-10 text-[var(--md-primary)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8-0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-4">Analizando tu biblioteca...</p>
                        </div>
                    </div>
                </main>
            </div>

            <!-- Barra de Reproducción -->
            <footer class="bg-[var(--md-surface-3)]/80 backdrop-blur-xl border-t border-[var(--md-outline)] p-3 sm:p-2 shrink-0">
                <div class="flex flex-col sm:flex-row items-center sm:space-x-4">
                    <!-- Info de la canción -->
                    <div class="flex items-center space-x-3 w-full sm:w-1/3 lg:w-1/4">
                        <!-- Added cursor-pointer and id -->
                        <img id="current-album-art" src="https://placehold.co/64x64/334155/e2e8f0?text=Music" class="w-14 h-14 sm:w-16 sm:h-16 rounded-xl shadow-md bg-slate-700 object-cover cursor-pointer">
                        <div class="overflow-hidden">
                            <h3 id="current-song-title" class="font-bold truncate text-sm sm:text-base">Selecciona una canción</h3>
                            <p id="current-song-artist" class="text-sm text-[var(--md-on-surface-variant)] truncate">...</p>
                        </div>
                    </div>

                    <!-- Controles de reproducción -->
                    <div class="flex flex-col items-center justify-center w-full mt-3 sm:mt-0 sm:w-1/3 lg:w-1/2">
                        <div class="flex items-center space-x-2 sm:space-x-4">
                            <button id="shuffle-btn" class="p-2 rounded-full text-[var(--md-on-surface-variant)] hover:bg-[var(--md-surface-variant)] transition-colors"><span class="material-symbols-outlined text-lg sm:text-2xl">shuffle</span></button>
                            <button id="prev-btn" class="text-[var(--md-on-surface)] hover:opacity-80 transition-opacity"><span class="material-symbols-outlined text-4xl">skip_previous</span></button>
                            <button id="play-pause-btn" class="text-[var(--md-primary)] hover:opacity-80 transition-opacity"><span id="play-icon" class="material-symbols-outlined text-5xl">play_circle</span><span id="pause-icon" class="material-symbols-outlined text-5xl hidden">pause_circle</span></button>
                            <button id="next-btn" class="text-[var(--md-on-surface)] hover:opacity-80 transition-opacity"><span class="material-symbols-outlined text-4xl">skip_next</span></button>
                            <button id="repeat-btn" class="p-2 rounded-full text-[var(--md-on-surface-variant)] hover:bg-[var(--md-surface-variant)] transition-colors"><span class="material-symbols-outlined text-lg sm:text-2xl">repeat</span></button>
                        </div>
                        <div class="w-full flex items-center space-x-2 mt-2">
                            <span id="current-time" class="text-xs text-[var(--md-on-surface-variant)] w-10 text-right">0:00</span>
                            <div id="progress-bar-container" class="w-full h-2 bg-[var(--md-surface-variant)] rounded-full cursor-pointer group">
                                <div id="progress-bar" class="h-full bg-[var(--md-primary)] rounded-full relative">
                                <div class="progress-bar-thumb w-4 h-4 bg-[var(--md-primary)] rounded-full absolute right-0 top-1/2 -translate-y-1/2 -mr-2 shadow-md opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                </div>
                            </div>
                            <span id="duration" class="text-xs text-[var(--md-on-surface-variant)] w-10">0:00</span>
                        </div>
                    </div>

                    <!-- Control de volumen y extras -->
                    <div class="hidden md:flex items-center justify-end space-x-4 w-full sm:w-1/3 lg:w-1/4">
                        <button id="cast-btn" class="p-2 rounded-full text-[var(--md-on-surface-variant)] hover:bg-[var(--md-surface-variant)] transition-colors"><span class="material-symbols-outlined">cast</span></button>
                        <button id="karaoke-btn" class="p-2 rounded-full text-[var(--md-on-surface-variant)] hover:bg-[var(--md-surface-variant)] transition-colors"><span class="material-symbols-outlined">mic_external_on</span></button>
                        <div class="flex items-center space-x-2">
                            <button id="volume-btn" class="p-2 rounded-full text-[var(--md-on-surface-variant)] hover:bg-[var(--md-surface-variant)] transition-colors">
                                <span id="volume-icon" class="material-symbols-outlined">volume_up</span>
                            </button>
                            <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="1" class="w-24 h-1 bg-[var(--md-surface-variant)] rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Vista del Receptor de Presentación (pantalla externa) -->
    <div id="presentation-receiver-view" class="hidden">
        <div id="receiver-karaoke-view" class="karaoke-view fixed inset-0 z-50 flex-col items-center justify-center p-2 sm:p-4 hidden">
             <div id="receiver-lyrics-container" class="lyrics-container w-full max-w-4xl h-full text-center font-bold text-xl sm:text-2xl md:text-3xl lg:text-4xl xl:text-5xl overflow-y-hidden scroll-smooth"></div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <!-- Modales -->
    <div id="create-playlist-modal" class="fixed inset-0 bg-[var(--md-scrim)] z-40 hidden items-center justify-center">
        <div class="bg-[var(--md-surface-3)] rounded-3xl shadow-xl p-6 w-full max-w-sm m-4">
            <h2 class="text-xl font-bold mb-4">Crear Nueva Playlist</h2>
            <input type="text" id="playlist-name-input" placeholder="Nombre de la playlist" class="w-full bg-[var(--md-surface-variant)] rounded-lg p-3 border border-[var(--md-outline)] focus:outline-none focus:ring-2 focus:ring-[var(--md-primary)]">
            <div class="flex justify-end space-x-2 mt-6">
                <button id="cancel-playlist-btn" class="px-4 py-2 rounded-full text-[var(--md-primary)] font-semibold hover:bg-[var(--md-primary-container)]">Cancelar</button>
                <button id="save-playlist-btn" class="px-6 py-2 rounded-full bg-[var(--md-primary)] text-[var(--md-on-primary)] font-semibold hover:opacity-90">Guardar</button>
            </div>
        </div>
    </div>
    <div id="add-to-playlist-modal" class="fixed inset-0 bg-[var(--md-scrim)] z-40 hidden items-center justify-center">
        <div class="bg-[var(--md-surface-3)] rounded-3xl shadow-xl p-6 w-full max-w-sm m-4">
            <h2 class="text-xl font-bold mb-4">Añadir a...</h2>
            <div id="playlist-selection-list" class="max-h-60 overflow-y-auto space-y-1"></div>
            <div class="flex justify-end mt-4">
                <button id="cancel-add-to-playlist-btn" class="px-4 py-2 rounded-full text-[var(--md-primary)] font-semibold hover:bg-[var(--md-primary-container)]">Cancelar</button>
            </div>
        </div>
    </div>
    <div id="delete-playlist-modal" class="fixed inset-0 bg-[var(--md-scrim)] z-40 hidden items-center justify-center">
        <div class="bg-[var(--md-surface-3)] rounded-3xl shadow-xl p-6 w-full max-w-sm m-4">
            <h2 class="text-xl font-bold mb-2">Eliminar Playlist</h2>
            <p id="delete-playlist-text" class="mb-4 text-[var(--md-on-surface-variant)]"></p>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="cancel-delete-btn" class="px-4 py-2 rounded-full text-[var(--md-primary)] font-semibold hover:bg-[var(--md-primary-container)]">Cancelar</button>
                <button id="confirm-delete-btn" class="px-6 py-2 rounded-full bg-red-600 text-white font-semibold hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>
    <div id="theme-modal" class="fixed inset-0 bg-[var(--md-scrim)] z-40 hidden items-center justify-center">
        <div class="bg-[var(--md-surface-3)] rounded-3xl shadow-xl p-6 w-full max-w-sm m-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Personalizar Tema</h2>
                <button id="close-theme-btn" class="p-2 rounded-full hover:bg-[var(--md-surface-variant)]"><span class="material-symbols-outlined">close</span></button>
            </div>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">Modo</h3>
                <div id="theme-mode-selector" class="flex items-center space-x-2 bg-[var(--md-surface-variant)] p-1 rounded-full">
                    <button data-theme="light" class="w-full p-2 rounded-full text-sm font-semibold">Claro</button>
                    <button data-theme="dark" class="w-full p-2 rounded-full text-sm font-semibold">Oscuro</button>
                    <button data-theme="system" class="w-full p-2 rounded-full text-sm font-semibold">Sistema</button>
                </div>
            </div>

            <div>
                <h3 class="text-lg font-semibold mb-2">Color de Acento</h3>
                <div id="accent-color-selector" class="grid grid-cols-5 gap-4">
                      <!-- Colors will be injected here -->
                </div>
            </div>
        </div>
    </div>
    <div id="event-modal" class="fixed inset-0 bg-[var(--md-scrim)] z-40 hidden items-center justify-center">
        <div class="bg-[var(--md-surface-3)] rounded-3xl shadow-xl p-6 w-full max-w-sm m-4">
            <h2 id="event-modal-title" class="text-xl font-bold mb-4">Añadir Evento</h2>
            <div class="space-y-4">
                <input type="text" id="event-title-input" placeholder="Título..." class="w-full bg-[var(--md-surface-variant)] rounded-lg p-3 border border-[var(--md-outline)] focus:outline-none focus:ring-2 focus:ring-[var(--md-primary)]">
                <div class="flex items-center space-x-4">
                    <label class="flex items-center"><input type="radio" name="eventType" value="event" checked class="mr-2 accent-[var(--md-primary)]"> Evento</label>
                    <label class="flex items-center"><input type="radio" name="eventType" value="task" class="mr-2 accent-[var(--md-primary)]"> Tarea</label>
                </div>
            </div>
            <div class="flex justify-between items-center mt-6">
                <button id="delete-event-btn" class="px-4 py-2 rounded-full text-red-600 font-semibold hover:bg-red-100 dark:hover:bg-red-900/50 hidden">Eliminar</button>
                <div class="flex justify-end space-x-2 flex-1">
                    <button id="cancel-event-btn" class="px-4 py-2 rounded-full text-[var(--md-primary)] font-semibold hover:bg-[var(--md-primary-container)]">Cancelar</button>
                    <button id="save-event-btn" class="px-6 py-2 rounded-full bg-[var(--md-primary)] text-[var(--md-on-primary)] font-semibold hover:opacity-90">Guardar</button>
                </div>
            </div>
        </div>
    </div>
    <div id="context-menu" class="fixed z-50 hidden bg-[var(--md-surface-3)] rounded-xl shadow-lg p-2 text-sm"></div>
    <div id="karaoke-modal" class="karaoke-view fixed inset-0 z-50 hidden flex-col items-center justify-center p-2 sm:p-4 transition-opacity duration-300 ease-in-out">
        <button id="close-karaoke-btn" class="absolute top-4 right-4 p-2 rounded-full text-white bg-white/10 hover:bg-white/20 z-10">
            <span class="material-symbols-outlined">close</span>
        </button>
        <div id="lyrics-container" class="lyrics-container w-full max-w-4xl h-full text-center font-bold text-xl sm:text-2xl md:text-3xl lg:text-4xl xl:text-5xl overflow-y-hidden scroll-smooth"></div>
    </div>
    <div id="video-modal" class="fixed inset-0 bg-[var(--md-scrim)] z-40 hidden items-center justify-center">
        <div class="bg-black rounded-lg shadow-xl w-full max-w-4xl aspect-video relative">
            <video id="video-player-element" class="w-full h-full rounded-lg" controls></video>
            <button id="close-video-btn" class="absolute -top-4 -right-4 p-2 rounded-full text-white bg-black/50 hover:bg-black/80 z-10"><span class="material-symbols-outlined">close</span></button>
        </div>
    </div>
     <div id="image-modal" class="fixed inset-0 bg-[var(--md-scrim)] z-40 hidden items-center justify-center p-4">
        <img id="image-viewer-element" class="max-w-full max-h-full rounded-lg shadow-xl">
        <button id="close-image-btn" class="absolute top-4 right-4 p-2 rounded-full text-white bg-black/50 hover:bg-black/80 z-10"><span class="material-symbols-outlined">close</span></button>
    </div>
    <input type="file" id="cover-art-input" class="hidden" accept="image/*">

    <!-- Now Playing View -->
    <div id="now-playing-view" class="fixed inset-0 z-50 hidden transform translate-y-full opacity-0 overflow-hidden">
        <!-- Blurred Background -->
        <div id="now-playing-bg" class="absolute inset-0 z-0"></div>

        <!-- Content -->
        <div class="relative z-10 flex flex-col h-full p-4 text-white">
            <!-- Header -->
            <div class="flex items-center justify-between shrink-0 mb-8">
                <button id="close-now-playing-btn" class="p-2 rounded-full hover:bg-white/10">
                    <span class="material-symbols-outlined">expand_more</span>
                </button>
                <span class="text-sm font-semibold uppercase tracking-wider">Reproduciendo</span>
                <button id="np-queue-btn" class="p-2 rounded-full hover:bg-white/10">
                    <span class="material-symbols-outlined">queue_music</span>
                </button>
            </div>

            <!-- Main Content Area -->
            <div class="flex-1 flex flex-col items-center justify-center overflow-hidden">
                <img id="np-album-art" src="https://placehold.co/400x400/334155/e2e8f0?text=Music" class="w-full max-w-sm aspect-square rounded-lg shadow-xl mb-8 object-cover">
                
                <div class="text-center mb-6 w-full px-4 overflow-hidden">
                    <h2 id="np-title" class="text-2xl font-bold truncate">Título de la Canción</h2>
                    <p id="np-artist" class="text-lg opacity-80 truncate">Artista</p>
                </div>

                <!-- Progress Bar -->
                <div class="w-full max-w-md mb-6 px-4">
                    <div id="np-progress-bar-container" class="w-full h-2 bg-white/20 rounded-full cursor-pointer group mb-2">
                        <div id="np-progress-bar" class="h-full bg-white rounded-full relative">
                            <div class="progress-bar-thumb w-4 h-4 bg-white rounded-full absolute right-0 top-1/2 -translate-y-1/2 -mr-2 shadow-md"></div>
                        </div>
                    </div>
                    <div class="flex justify-between text-xs opacity-80">
                        <span id="np-current-time">0:00</span>
                        <span id="np-duration">0:00</span>
                    </div>
                </div>

                <!-- Controls -->
                <div class="flex items-center justify-center space-x-6 w-full max-w-md mb-8">
                    <button id="np-shuffle-btn" class="p-3 rounded-full hover:bg-white/10 text-white/80"><span class="material-symbols-outlined text-3xl">shuffle</span></button>
                    <button id="np-prev-btn" class="text-white hover:opacity-80 transition-opacity"><span class="material-symbols-outlined text-5xl">skip_previous</span></button>
                    <button id="np-play-pause-btn" class="text-white hover:opacity-80 transition-opacity"><span id="np-play-icon" class="material-symbols-outlined text-7xl">play_circle</span><span id="np-pause-icon" class="material-symbols-outlined text-7xl hidden">pause_circle</span></button>
                    <button id="np-next-btn" class="text-white hover:opacity-80 transition-opacity"><span class="material-symbols-outlined text-5xl">skip_next</span></button>
                    <button id="np-repeat-btn" class="p-3 rounded-full hover:bg-white/10 text-white/80"><span class="material-symbols-outlined text-3xl">repeat</span></button>
                </div>
            </div>

             <!-- Footer Buttons -->
             <div class="flex justify-around items-center shrink-0 pt-4 border-t border-white/10">
                <button id="np-lyrics-btn" class="p-3 rounded-full hover:bg-white/10 text-white/80 flex flex-col items-center text-xs">
                    <span class="material-symbols-outlined mb-1">mic_external_on</span>
                    Letra
                </button>
                <!-- This button is already handled by the header queue button now -->
                <!-- <button id="np-queue-btn-footer" class="p-3 rounded-full hover:bg-white/10 text-white/80 flex flex-col items-center text-xs">
                    <span class="material-symbols-outlined mb-1">queue_music</span>
                    Cola
                </button> -->
            </div>
        </div>

        <!-- Queue Panel -->
        <div id="queue-panel" class="absolute inset-0 z-20 bg-[var(--md-surface-3)] dark:bg-[var(--md-surface-2)] text-[var(--md-on-surface)] transform translate-x-full overflow-hidden flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-[var(--md-outline)] shrink-0">
                <h3 class="text-lg font-semibold">Cola de Reproducción</h3>
                <button id="close-queue-btn" class="p-2 rounded-full hover:bg-[var(--md-surface-variant)]">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <ul id="queue-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Queue items will be rendered here -->
            </ul>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration will be injected here
        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Error parsing Firebase config:", e);
            firebaseConfig = {}; // Use empty config on error
        }

        // Initialize Firebase
        let app, auth;
        if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                // Handle initialization error (e.g., show a message to the user)
            }
        } else {
             console.warn("Firebase configuration is missing or invalid. Authentication features will be disabled.");
        }


        // --- Authentication Functions ---
        const provider = auth ? new GoogleAuthProvider() : null;
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userInfoDiv = document.getElementById('user-info');

        async function signInWithGoogle() {
            if (!auth || !provider) {
                console.error("Firebase Auth not initialized.");
                alert("La autenticación no está disponible en este momento."); // Replace with custom modal
                return;
            }
            try {
                const result = await signInWithPopup(auth, provider);
                // This gives you a Google Access Token. You can use it to access the Google API.
                const credential = GoogleAuthProvider.credentialFromResult(result);
                const token = credential.accessToken;
                // The signed-in user info.
                const user = result.user;
                console.log("User signed in: ", user);
            } catch (error) {
                // Handle Errors here.
                const errorCode = error.code;
                const errorMessage = error.message;
                // The email of the user's account used.
                const email = error.customData?.email;
                // The AuthCredential type that was used.
                const credential = GoogleAuthProvider.credentialFromError(error);
                console.error("Error during sign in:", errorCode, errorMessage);
                // Show user-friendly error message
                alert(`Error al iniciar sesión: ${errorMessage}`); // Replace with custom modal
            }
        }

        async function signOutUser() {
            if (!auth) return;
            try {
                await signOut(auth);
                console.log("User signed out.");
            } catch (error) {
                console.error("Error signing out:", error);
                 alert(`Error al cerrar sesión: ${error.message}`); // Replace with custom modal
            }
        }

        // Listen for auth state changes
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user && !user.isAnonymous) {
                    // User is signed in
                    userInfoDiv.textContent = user.displayName || user.email;
                    signInBtn.classList.add('hidden');
                    signOutBtn.classList.remove('hidden');
                     signOutBtn.classList.add('flex', 'items-center', 'justify-center'); // Make sure flex is added
                } else {
                    // User is signed out or anonymous
                    userInfoDiv.textContent = 'Invitado';
                    signInBtn.classList.remove('hidden');
                    signOutBtn.classList.add('hidden');
                     signOutBtn.classList.remove('flex', 'items-center', 'justify-center'); // Remove flex
                }
            });

             // Initial sign-in check (using custom token or anonymous)
            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         console.log("Attempting sign in with custom token...");
                        await signInWithCustomToken(auth, __initial_auth_token);
                         console.log("Successfully signed in with custom token.");
                    } else if (!auth.currentUser) {
                         console.log("No initial token, attempting anonymous sign in...");
                        await signInAnonymously(auth);
                         console.log("Successfully signed in anonymously.");
                    } else {
                         console.log("User already signed in:", auth.currentUser.uid, "Is Anonymous:", auth.currentUser.isAnonymous);
                    }
                } catch (error) {
                    console.error("Error during initial sign-in:", error);
                     // Fallback to anonymous if custom token fails
                     if (!auth.currentUser) {
                         try {
                              console.log("Initial sign-in failed, attempting anonymous sign in as fallback...");
                             await signInAnonymously(auth);
                              console.log("Successfully signed in anonymously after fallback.");
                         } catch (anonError) {
                             console.error("Error during anonymous sign-in fallback:", anonError);
                             alert("No se pudo iniciar sesión. Algunas funciones pueden estar deshabilitadas."); // Replace with modal
                         }
                     }
                }
            })();


        } else {
            // Hide auth buttons if Firebase couldn't initialize
            signInBtn.classList.add('hidden');
            signOutBtn.classList.add('hidden');
            userInfoDiv.textContent = 'Auth no disponible';
        }


        // --- Add Event Listeners for Buttons ---
        signInBtn.addEventListener('click', signInWithGoogle);
        signOutBtn.addEventListener('click', signOutUser);


        // --- Existing Music Player Logic Starts Here ---
        document.addEventListener('DOMContentLoaded', () => {
             if (!app) return; // Don't run player logic if Firebase failed
            
            // --- STATE MANAGEMENT ---
            let folders = {};
            let activeFolderName = null;
            let allMedia = [];
            let allSongs = [], allVideos = [], allImages = [];
            let albums = {};
            let artists = {};
            let playlists = {};
            let calendarEvents = {};
            let mediaMap = new Map();
            let currentView = 'songs';
            let currentQueue = [];
            let currentQueueIndex = -1;
            let playHistory = [];
            let historyIndex = -1;
            let isPlaying = false;
            let isShuffle = false;
            let isRepeat = false;
            const placeholderArt = 'https://placehold.co/600x600/334155/e2e8f0?text=Music';
            let playlistToDelete = null;
            let lyricsData = null;
            let lyricsRequestController = null;
            let currentLyricIndex = -1;
            let presentationRequest = null;
            let presentationConnection = null;
            let calendarDate = new Date();
            let albumToEdit = null;
            let sortableQueue = null; // Variable for Sortable instance


            // --- DOM ELEMENTS ---
            const folderInput = document.getElementById('folder-input');
            const addFolderInput = document.getElementById('add-folder-input');
            const folderList = document.getElementById('folder-list');
            const mainContent = document.getElementById('main-content');
            const initialPrompt = document.getElementById('initial-prompt');
            const loadingState = document.getElementById('loading-state');
            const mainHeader = document.getElementById('main-header');
            const headerTitle = document.getElementById('header-title');
            const audioPlayer = document.getElementById('audio-player');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const shuffleBtn = document.getElementById('shuffle-btn');
            const repeatBtn = document.getElementById('repeat-btn');
            const currentAlbumArt = document.getElementById('current-album-art');
            const currentSongTitle = document.getElementById('current-song-title');
            const currentSongArtist = document.getElementById('current-song-artist');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const volumeSlider = document.getElementById('volume-slider');
            const navLinks = document.getElementById('nav-links');
            const menuBtn = document.getElementById('menu-btn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const searchInput = document.getElementById('search-input');
            const createPlaylistModal = document.getElementById('create-playlist-modal');
            const cancelPlaylistBtn = document.getElementById('cancel-playlist-btn');
            const savePlaylistBtn = document.getElementById('save-playlist-btn');
            const playlistNameInput = document.getElementById('playlist-name-input');
            const addToPlaylistModal = document.getElementById('add-to-playlist-modal');
            const playlistSelectionList = document.getElementById('playlist-selection-list');
            const cancelAddToPlaylistBtn = document.getElementById('cancel-add-to-playlist-btn');
            const contextMenu = document.getElementById('context-menu');
            const deletePlaylistModal = document.getElementById('delete-playlist-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const deletePlaylistText = document.getElementById('delete-playlist-text');
            const karaokeBtn = document.getElementById('karaoke-btn');
            const karaokeModal = document.getElementById('karaoke-modal');
            const closeKaraokeBtn = document.getElementById('close-karaoke-btn');
            const lyricsContainer = document.getElementById('lyrics-container');
            const castBtn = document.getElementById('cast-btn');
            const volumeBtn = document.getElementById('volume-btn');
            const volumeIcon = document.getElementById('volume-icon');
            const themeBtn = document.getElementById('theme-btn');
            const themeModal = document.getElementById('theme-modal');
            const closeThemeBtn = document.getElementById('close-theme-btn');
            const themeModeSelector = document.getElementById('theme-mode-selector');
            const accentColorSelector = document.getElementById('accent-color-selector');
            const videoModal = document.getElementById('video-modal');
            const videoPlayerElement = document.getElementById('video-player-element');
            const closeVideoBtn = document.getElementById('close-video-btn');
            const imageModal = document.getElementById('image-modal');
            const imageViewerElement = document.getElementById('image-viewer-element');
            const closeImageBtn = document.getElementById('close-image-btn');
            const eventModal = document.getElementById('event-modal');
            const eventModalTitle = document.getElementById('event-modal-title');
            const eventTitleInput = document.getElementById('event-title-input');
            const cancelEventBtn = document.getElementById('cancel-event-btn');
            const saveEventBtn = document.getElementById('save-event-btn');
            const deleteEventBtn = document.getElementById('delete-event-btn');
            const coverArtInput = document.getElementById('cover-art-input');
            // Now Playing View Elements
            const nowPlayingView = document.getElementById('now-playing-view');
            const nowPlayingBg = document.getElementById('now-playing-bg');
            const closeNowPlayingBtn = document.getElementById('close-now-playing-btn');
            const npAlbumArt = document.getElementById('np-album-art');
            const npTitle = document.getElementById('np-title');
            const npArtist = document.getElementById('np-artist');
            const npProgressBarContainer = document.getElementById('np-progress-bar-container');
            const npProgressBar = document.getElementById('np-progress-bar');
            const npCurrentTime = document.getElementById('np-current-time');
            const npDuration = document.getElementById('np-duration');
            const npShuffleBtn = document.getElementById('np-shuffle-btn');
            const npPrevBtn = document.getElementById('np-prev-btn');
            const npPlayPauseBtn = document.getElementById('np-play-pause-btn');
            const npPlayIcon = document.getElementById('np-play-icon');
            const npPauseIcon = document.getElementById('np-pause-icon');
            const npNextBtn = document.getElementById('np-next-btn');
            const npRepeatBtn = document.getElementById('np-repeat-btn');
            const npLyricsBtn = document.getElementById('np-lyrics-btn');
            const npQueueBtn = document.getElementById('np-queue-btn');
            // Queue Panel Elements
            const queuePanel = document.getElementById('queue-panel');
            const closeQueueBtn = document.getElementById('close-queue-btn');
            const queueList = document.getElementById('queue-list');


            // --- LOCALSTORAGE & DATA ---
            function loadPlaylists() {
                const savedPlaylists = localStorage.getItem('musicPlayerPlaylists');
                if (savedPlaylists) playlists = JSON.parse(savedPlaylists);
            }
            function savePlaylists() {
                localStorage.setItem('musicPlayerPlaylists', JSON.stringify(playlists));
            }
            function loadCalendarEvents() {
                const savedEvents = localStorage.getItem('musicPlayerCalendarEvents');
                if (savedEvents) calendarEvents = JSON.parse(savedEvents);
            }
            function saveCalendarEvents() {
                localStorage.setItem('musicPlayerCalendarEvents', JSON.stringify(calendarEvents));
            }
            function saveCustomCover(albumKey, dataUrl) {
                let customCovers = JSON.parse(localStorage.getItem('customAlbumCovers') || '{}');
                customCovers[albumKey] = dataUrl;
                localStorage.setItem('customAlbumCovers', JSON.stringify(customCovers));
            }

            function getCustomCover(albumKey) {
                let customCovers = JSON.parse(localStorage.getItem('customAlbumCovers') || '{}');
                return customCovers[albumKey];
            }

            function updateMediaCollections() {
                allMedia = Object.values(folders).flat();
                allSongs = allMedia.filter(item => item.type === 'audio');
                allVideos = allMedia.filter(item => item.type === 'video');
                allImages = allMedia.filter(item => item.type === 'image');

                mediaMap.clear();
                allMedia.forEach(item => {
                    const key = `${item.title}|${item.artist || ''}|${item.album || ''}`.toLowerCase().trim();
                    mediaMap.set(key, item);
                });
                relinkPlaylists();
            }
            function relinkPlaylists() {
                for (const playlistName in playlists) {
                    playlists[playlistName].songs = playlists[playlistName].songs.filter(songKey => mediaMap.has(songKey));
                }
                savePlaylists();
            }
            loadPlaylists();
            loadCalendarEvents();

            // --- ITUNES API ---
            async function fetchAlbumArt(title, artist) {
                if (!title || !artist || !navigator.onLine) return placeholderArt;
                const searchTerm = `${artist} ${title}`;
                const url = `https://itunes.apple.com/search?term=${encodeURIComponent(searchTerm)}&entity=song&limit=1`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) return placeholderArt;
                    const data = await response.json();
                    return data.resultCount > 0 && data.results[0].artworkUrl100 ? data.results[0].artworkUrl100.replace('100x100', '600x600') : placeholderArt;
                } catch (error) { console.error('Error fetching album art:', error); return placeholderArt; }
            }

            // --- FOLDER & FILE HANDLING ---
            const handleFolderSelection = async (event) => {
                const files = event.target.files;
                if (files.length === 0) return;

                let folderName = "Música Importada";
                if (files[0].webkitRelativePath) {
                    folderName = files[0].webkitRelativePath.split('/')[0];
                }
                if (folders[folderName]) {
                    // Using a custom modal instead of confirm() would be ideal in a full app
                    if (!window.confirm(`La carpeta "${folderName}" ya existe. ¿Quieres reemplazarla?`)) {
                        return;
                    }
                }
                
                mainContent.innerHTML = ''; mainContent.appendChild(loadingState); loadingState.classList.remove('hidden');
                
                const mediaFiles = Array.from(files).filter(file => file.type.startsWith('audio/') || file.type.startsWith('video/') || file.type.startsWith('image/'));
                
                const mediaPromises = mediaFiles.map(file => {
                    if (file.type.startsWith('audio/')) return parseSongMetadata(file);
                    if (file.type.startsWith('video/')) return parseVideoMetadata(file);
                    if (file.type.startsWith('image/')) return parseImageMetadata(file);
                    return null;
                }).filter(Boolean);

                const loadedMedia = await Promise.all(mediaPromises);

                const uniqueMedia = new Map();
                loadedMedia.forEach(item => {
                    const key = `${item.title}|${item.artist || ''}|${item.album || ''}`.toLowerCase().trim();
                    if (!uniqueMedia.has(key) || item.fileSize > uniqueMedia.get(key).fileSize) { uniqueMedia.set(key, item); }
                });

                folders[folderName] = Array.from(uniqueMedia.values()).sort((a, b) => a.title.localeCompare(b.title));
                activeFolderName = folderName;

                updateMediaCollections();
                groupSongsByAlbum(); 
                groupSongsByArtist();
                renderFolderList();

                loadingState.classList.add('hidden');
                switchView('songs');
            };

            folderInput.addEventListener('change', handleFolderSelection);
            addFolderInput.addEventListener('change', handleFolderSelection);
            
            function groupSongsByAlbum() {
                albums = allSongs.reduce((acc, song) => {
                    const albumTitle = song.album || 'Álbum Desconocido';
                    if (!acc[albumTitle]) {
                        acc[albumTitle] = { title: albumTitle, artist: song.artist, picture: song.picture, songs: [] };
                    }
                    acc[albumTitle].songs.push(song);
                    return acc;
                }, {});

                // Now, apply custom covers
                Object.values(albums).forEach(album => {
                    const albumKey = `${album.artist}|${album.title}`.toLowerCase().trim();
                    const customCover = getCustomCover(albumKey);
                    if (customCover) {
                        album.picture = customCover;
                        album.songs.forEach(song => song.picture = customCover);
                    }
                });
            }
            function groupSongsByArtist() {
                artists = allSongs.reduce((acc, song) => {
                    const artistName = song.artist || 'Artista Desconocido';
                    if (!acc[artistName]) { acc[artistName] = { name: artistName, picture: song.picture, songs: [] }; }
                    acc[artistName].songs.push(song); return acc;
                }, {});
            }
            function parseSongMetadata(file) {
                 return new Promise((resolve) => {
                       window.jsmediatags.read(file, {
                             onSuccess: (tag) => {
                                 const { title, artist, album, picture } = tag.tags;
                                 const songObject = { type: 'audio', title: title || file.name.replace(/\.[^/.]+$/, ""), artist: artist || 'Artista Desconocido', album: album || 'Álbum Desconocido', picture: placeholderArt, url: URL.createObjectURL(file), fileSize: file.size, duration: 0 };
                                 if (picture) { let binary = ''; const bytes = new Uint8Array(picture.data); for (let i = 0; i < bytes.byteLength; i++) { binary += String.fromCharCode(bytes[i]); } songObject.picture = `data:${picture.format};base64,${btoa(binary)}`;
                                 } else { fetchAlbumArt(songObject.title, songObject.artist).then(art => songObject.picture = art); }
                                 const tempAudio = document.createElement('audio'); tempAudio.src = songObject.url;
                                 tempAudio.onloadedmetadata = () => { songObject.duration = tempAudio.duration; resolve(songObject); };
                                 tempAudio.onerror = () => resolve(songObject);
                             },
                             onError: () => {
                                  const songObject = { type: 'audio', title: file.name.replace(/\.[^/.]+$/, ""), artist: 'Artista Desconocido', album: 'Álbum Desconocido', picture: placeholderArt, url: URL.createObjectURL(file), fileSize: file.size, duration: 0 };
                                  fetchAlbumArt(songObject.title, 'Artista Desconocido').then(art => songObject.picture = art);
                                  const tempAudio = document.createElement('audio'); tempAudio.src = songObject.url;
                                  tempAudio.onloadedmetadata = () => { songObject.duration = tempAudio.duration; resolve(songObject); };
                                  tempAudio.onerror = () => resolve(songObject);
                             }
                       });
                 });
            }
            function parseVideoMetadata(file) {
                return new Promise((resolve) => {
                    const video = document.createElement('video');
                    video.preload = 'metadata';
                    video.src = URL.createObjectURL(file);
                    video.onloadedmetadata = () => {
                        const videoObject = { type: 'video', title: file.name.replace(/\.[^/.]+$/, ""), url: video.src, duration: video.duration, picture: placeholderArt, fileSize: file.size };
                        video.currentTime = 1;
                        video.onseeked = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                            videoObject.picture = canvas.toDataURL('image/jpeg');
                            resolve(videoObject);
                        };
                        video.onerror = () => resolve(videoObject); // Resolve even if thumbnail fails
                    };
                    video.onerror = () => { // Fails to load metadata
                         const videoObject = { type: 'video', title: file.name.replace(/\.[^/.]+$/, ""), url: URL.createObjectURL(file), duration: 0, picture: placeholderArt, fileSize: file.size };
                         resolve(videoObject);
                    };
                });
            }
            function parseImageMetadata(file) {
                 return Promise.resolve({ type: 'image', title: file.name.replace(/\.[^/.]+$/, ""), url: URL.createObjectURL(file), picture: URL.createObjectURL(file), fileSize: file.size });
            }

            // --- THEME CUSTOMIZATION ---
            const colorPalettes = {
                blue: { light: { '--md-primary': '#3b82f6', '--md-on-primary': '#ffffff', '--md-primary-container': '#dbeafe', '--md-on-primary-container': '#1e40af' }, dark: { '--md-primary': '#60a5fa', '--md-on-primary': '#0c2f66', '--md-primary-container': '#1e3a8a', '--md-on-primary-container': '#bfdbfe' }},
                green: { light: { '--md-primary': '#22c55e', '--md-on-primary': '#ffffff', '--md-primary-container': '#dcfce7', '--md-on-primary-container': '#15803d' }, dark: { '--md-primary': '#4ade80', '--md-on-primary': '#052e16', '--md-primary-container': '#166534', '--md-on-primary-container': '#bbf7d0' }},
                purple: { light: { '--md-primary': '#8b5cf6', '--md-on-primary': '#ffffff', '--md-primary-container': '#ede9fe', '--md-on-primary-container': '#5b21b6' }, dark: { '--md-primary': '#a78bfa', '--md-on-primary': '#240866', '--md-primary-container': '#4c1d95', '--md-on-primary-container': '#ddd6fe' }},
                red: { light: { '--md-primary': '#ef4444', '--md-on-primary': '#ffffff', '--md-primary-container': '#fee2e2', '--md-on-primary-container': '#991b1b' }, dark: { '--md-primary': '#f87171', '--md-on-primary': '#450a0a', '--md-primary-container': '#7f1d1d', '--md-on-primary-container': '#fecaca' }},
                orange: { light: { '--md-primary': '#f97316', '--md-on-primary': '#ffffff', '--md-primary-container': '#ffedd5', '--md-on-primary-container': '#9a3412' }, dark: { '--md-primary': '#fb923c', '--md-on-primary': '#4d1c07', '--md-primary-container': '#7c2d12', '--md-on-primary-container': '#fed7aa' }},
            };

            function applyAccentColor(colorName) {
                const isDarkMode = document.documentElement.classList.contains('dark');
                const palette = colorPalettes[colorName][isDarkMode ? 'dark' : 'light'];
                for (const property in palette) {
                    document.documentElement.style.setProperty(property, palette[property]);
                }
                localStorage.setItem('accentColor', colorName);
                updateActiveColor();
            }

            function applyTheme(mode) {
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');
                if (mode === 'system') {
                    document.documentElement.classList.toggle('dark', systemPrefersDark.matches);
                } else {
                    document.documentElement.classList.toggle('dark', mode === 'dark');
                }
                localStorage.setItem('themeMode', mode);
                applyAccentColor(localStorage.getItem('accentColor') || 'blue');
                updateActiveThemeButton();
            }

            function updateActiveThemeButton() {
                const mode = localStorage.getItem('themeMode') || 'system';
                themeModeSelector.querySelectorAll('button').forEach(btn => {
                    if (btn.dataset.theme === mode) {
                        btn.classList.add('bg-[var(--md-primary-container)]', 'text-[var(--md-on-primary-container)]');
                    } else {
                        btn.classList.remove('bg-[var(--md-primary-container)]', 'text-[var(--md-on-primary-container)]');
                    }
                });
            }

            function updateActiveColor() {
                const activeColor = localStorage.getItem('accentColor') || 'blue';
                accentColorSelector.querySelectorAll('button').forEach(btn => {
                    btn.innerHTML = btn.dataset.color === activeColor ? `<span class="material-symbols-outlined">done</span>` : '';
                });
            }
            
            themeBtn.addEventListener('click', () => showModal(themeModal));
            closeThemeBtn.addEventListener('click', () => hideModal(themeModal));
            themeModeSelector.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    applyTheme(e.target.dataset.theme);
                }
            });

            Object.keys(colorPalettes).forEach(colorName => {
                const color = colorPalettes[colorName].light['--md-primary'];
                const button = document.createElement('button');
                button.className = 'w-10 h-10 rounded-full flex items-center justify-center text-white';
                button.style.backgroundColor = color;
                button.dataset.color = colorName;
                button.onclick = () => applyAccentColor(colorName);
                accentColorSelector.appendChild(button);
            });
            
            // Init theme
            const savedTheme = localStorage.getItem('themeMode') || 'system';
            const savedColor = localStorage.getItem('accentColor') || 'blue';
            applyTheme(savedTheme);
            applyAccentColor(savedColor);
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if(localStorage.getItem('themeMode') === 'system') {
                    applyTheme('system');
                }
            });


            // --- UI & NAVIGATION ---
            function renderFolderList() {
                folderList.innerHTML = '';
                Object.keys(folders).sort().forEach(name => {
                    const li = document.createElement('li');
                    li.className = 'group flex items-center justify-between p-2 rounded-full cursor-pointer';
                    if (name === activeFolderName) {
                        li.classList.add('bg-[var(--md-primary-container)]', 'text-[var(--md-on-primary-container)]', 'font-semibold');
                    } else {
                        li.classList.add('hover:bg-[var(--md-surface-variant)]');
                    }
                    li.dataset.folderName = name;
                    
                    const span = document.createElement('span');
                    span.className = "truncate pl-2";
                    span.textContent = name;
                    li.appendChild(span);

                    const button = document.createElement('button');
                    button.className = "ml-2 p-1 rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-500/20 text-red-500";
                    button.innerHTML = `<span class="material-symbols-outlined text-sm">close</span>`;
                    button.onclick = (e) => {
                        e.stopPropagation();
                        delete folders[name];
                        if (activeFolderName === name) {
                            activeFolderName = Object.keys(folders)[0] || null;
                        }
                        updateMediaCollections();
                        renderFolderList();
                        switchView('songs');
                    };
                    li.appendChild(button);
                    
                    li.onclick = () => {
                        activeFolderName = name;
                        renderFolderList();
                        switchView('songs');
                    };
                    folderList.appendChild(li);
                });
            }

            const toggleSidebar = () => { sidebar.classList.toggle('-translate-x-full'); sidebarOverlay.classList.toggle('hidden'); };
            menuBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            navLinks.addEventListener('click', (e) => {
                e.preventDefault();
                const link = e.target.closest('.nav-link');
                if (link && link.dataset.view) {
                    switchView(link.dataset.view);
                    if (window.innerWidth < 768) { toggleSidebar(); }
                }
            });
            function switchView(view, data) {
                currentView = view;
                const backButton = mainHeader.querySelector('.back-btn');
                if (backButton) backButton.remove();

                if (Object.keys(folders).length === 0 && view !== 'initial' && view !== 'history') { 
                    mainContent.innerHTML = ''; mainContent.appendChild(initialPrompt); return; 
                }
                
                mainContent.innerHTML = ''; headerTitle.textContent = ''; searchInput.value = '';
                document.querySelectorAll('.nav-link').forEach(l => {
                    l.classList.remove('bg-[var(--md-primary-container)]', 'text-[var(--md-on-primary-container)]', 'font-semibold');
                    l.classList.add('hover:bg-[var(--md-surface-variant)]');
                });
                const activeLink = document.querySelector(`.nav-link[data-view="${view.split('-')[0]}"]`);
                if(activeLink) {
                    activeLink.classList.add('bg-[var(--md-primary-container)]', 'text-[var(--md-on-primary-container)]', 'font-semibold');
                    activeLink.classList.remove('hover:bg-[var(--md-surface-variant)]');
                }
                
                const createBackButton = (targetView) => {
                    const btn = document.createElement('button');
                    btn.innerHTML = `<span class="material-symbols-outlined">arrow_back</span>`;
                    btn.className = 'back-btn p-1 mr-2 -ml-1 rounded-full hover:bg-[var(--md-surface-variant)]';
                    btn.onclick = () => switchView(targetView);
                    headerTitle.parentNode.insertBefore(btn, headerTitle);
                };
                switch (view) {
                    case 'songs': 
                        headerTitle.textContent = activeFolderName ? `Canciones en ${activeFolderName}` : 'Canciones';
                        const activeSongs = activeFolderName ? (folders[activeFolderName] || []).filter(item => item.type === 'audio') : allSongs;
                        if (activeSongs.length > 0) {
                            mainContent.appendChild(createSongTable(activeSongs)); 
                        } else {
                            mainContent.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center text-[var(--md-on-surface-variant)] p-4"><span class="material-symbols-outlined text-7xl mb-4">music_off</span><h2 class="text-xl font-semibold mb-2 text-[var(--md-on-surface)]">No hay canciones</h2><p>Esta vista no contiene archivos de audio.</p></div>`;
                        }
                        break;
                    case 'videos': 
                        headerTitle.textContent = activeFolderName ? `Vídeos en ${activeFolderName}` : 'Vídeos';
                        const activeVideos = activeFolderName ? (folders[activeFolderName] || []).filter(item => item.type === 'video') : allVideos;
                        mainContent.appendChild(createMediaGrid(activeVideos, 'video'));
                        break;
                    case 'images':
                        headerTitle.textContent = activeFolderName ? `Imágenes en ${activeFolderName}` : 'Imágenes';
                        const activeImages = activeFolderName ? (folders[activeFolderName] || []).filter(item => item.type === 'image') : allImages;
                        mainContent.appendChild(createMediaGrid(activeImages, 'image'));
                        break;
                    case 'albums': headerTitle.textContent = 'Álbumes'; renderAlbumGrid(); break;
                    case 'artists': headerTitle.textContent = 'Artistas'; renderArtistList(); break;
                    case 'playlists': headerTitle.textContent = 'Playlists'; renderPlaylistsView(); break;
                    case 'history': headerTitle.textContent = 'Calendario'; mainContent.appendChild(renderCalendarView(calendarDate)); break;
                    case 'album-detail':
                        const album = albums[data]; headerTitle.textContent = album.title; createBackButton('albums');
                        mainContent.appendChild(createSongTable(album.songs)); break;
                    case 'artist-detail':
                        const artist = artists[data]; headerTitle.textContent = artist.name; createBackButton('artists');
                        mainContent.appendChild(createSongTable(artist.songs)); break;
                    case 'playlist-detail':
                        const playlist = playlists[data];
                        if (playlist) {
                            headerTitle.textContent = playlist.name; createBackButton('playlists');
                            const playlistSongs = playlist.songs.map(key => mediaMap.get(key)).filter(item => item && item.type === 'audio');
                            mainContent.appendChild(createSongTable(playlistSongs));
                        }
                        break;
                }
            }
            function renderAlbumGrid(){
                const grid = document.createElement('div'); grid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6';
                Object.values(albums).sort((a,b) => a.title.localeCompare(b.title)).forEach(album => {
                    const el = document.createElement('div'); el.className = 'cursor-pointer group album-grid-item';
                    el.innerHTML = `<img src="${album.picture}" onerror="this.src='${placeholderArt}'" class="w-full h-auto aspect-square rounded-2xl shadow-lg group-hover:opacity-80 transition-opacity object-cover"><h3 class="font-semibold mt-2 truncate text-sm sm:text-base">${album.title}</h3><p class="text-sm text-[var(--md-on-surface-variant)] truncate">${album.artist}</p>`;
                    el.addEventListener('click', () => switchView('album-detail', album.title));
                    el.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        albumToEdit = album.title;
                        showContextMenuForAlbum(e, album);
                    });
                    grid.appendChild(el);
                }); mainContent.appendChild(grid);
            }
            function renderArtistList(){
                const list = document.createElement('div'); list.className = 'space-y-1';
                Object.values(artists).sort((a,b) => a.name.localeCompare(b.name)).forEach(artist => {
                    const el = document.createElement('div'); el.className = 'flex items-center p-2 rounded-lg hover:bg-[var(--md-surface-variant)] cursor-pointer artist-list-item';
                    el.innerHTML = `<img src="${artist.picture}" onerror="this.src='${placeholderArt}'" class="w-12 h-12 rounded-full mr-4 object-cover"><span class="font-semibold">${artist.name}</span>`;
                    el.addEventListener('click', () => switchView('artist-detail', artist.name)); list.appendChild(el);
                }); mainContent.appendChild(list);
            }
             function renderPlaylistsView() {
                mainContent.innerHTML = '';
                const playlistNames = Object.keys(playlists).sort();
                
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6';

                const createCard = document.createElement('div');
                createCard.className = 'cursor-pointer group relative flex items-center justify-center aspect-square bg-[var(--md-surface-variant)] rounded-2xl hover:bg-[var(--md-outline)] transition-colors';
                createCard.innerHTML = `
                    <div class="text-center text-[var(--md-on-surface-variant)]">
                        <span class="material-symbols-outlined text-5xl">add</span>
                        <p class="font-semibold mt-2">Crear Playlist</p>
                    </div>
                `;
                createCard.onclick = () => { 
                    playlistNameInput.value = ''; 
                    showModal(createPlaylistModal); 
                    playlistNameInput.focus(); 
                };
                grid.appendChild(createCard);

                playlistNames.forEach(name => {
                    const playlist = playlists[name];
                    const firstSong = mediaMap.get(playlist.songs[0]);
                    const picture = firstSong ? firstSong.picture : placeholderArt;
                    const el = document.createElement('div'); el.className = 'group relative';
                    el.innerHTML = `
                        <div class="absolute top-2 right-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button title="Eliminar playlist" class="delete-playlist-btn p-1.5 rounded-full bg-black/50 text-white hover:bg-red-600 transition-colors">
                                <span class="material-symbols-outlined text-lg">delete</span>
                            </button>
                        </div>
                        <div class="playlist-card-content cursor-pointer">
                            <div class="relative w-full h-auto aspect-square">
                                <img src="${picture}" onerror="this.src='${placeholderArt}'" class="w-full h-full rounded-2xl shadow-lg group-hover:opacity-80 transition-opacity object-cover">
                                <div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-2xl">
                                    <span class="material-symbols-outlined text-white text-6xl">play_circle</span>
                                </div>
                            </div>
                            <h3 class="font-semibold mt-2 truncate text-sm sm:text-base">${playlist.name}</h3>
                            <p class="text-sm text-[var(--md-on-surface-variant)] truncate">${playlist.songs.length} canciones</p>
                        </div>
                    `;
                    el.querySelector('.playlist-card-content').addEventListener('click', () => switchView('playlist-detail', playlist.name));
                    el.querySelector('.delete-playlist-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        openDeletePlaylistModal(playlist.name);
                    });
                    grid.appendChild(el);
                });
                mainContent.appendChild(grid);
            }
            function createSongTable(songs) {
                const table = document.createElement('table'); table.className = 'w-full text-left border-separate border-spacing-y-1';
                table.innerHTML = `<thead class="text-xs text-[var(--md-on-surface-variant)] uppercase"><tr><th class="p-3 w-12 text-center">#</th><th class="p-3">Título</th><th class="p-3 hidden sm:table-cell">Artista</th><th class="p-3 hidden md:table-cell">Álbum</th><th class="p-3 text-right"><span class="material-symbols-outlined text-base">schedule</span></th><th class="p-3 w-12"></th></tr></thead>`;
                const tbody = document.createElement('tbody');
                songs.forEach((song, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-[var(--md-surface-variant)]/50 rounded-lg song-item group';
                    const songKey = `${song.title}|${song.artist}|${song.album}`.toLowerCase().trim();
                    tr.dataset.songKey = songKey;
                    
                    tr.innerHTML = `
                        <td class="p-3 w-12 text-center text-[var(--md-on-surface-variant)] rounded-l-lg cursor-pointer">
                            <span class="song-index group-hover:hidden">${index + 1}</span>
                            <span class="material-symbols-outlined play-icon hidden group-hover:inline">play_arrow</span>
                        </td>
                        <td class="p-3 font-semibold cursor-pointer">${song.title}<p class="sm:hidden text-xs font-normal text-[var(--md-on-surface-variant)]">${song.artist}</p></td>
                        <td class="p-3 text-[var(--md-on-surface-variant)] hidden sm:table-cell cursor-pointer hover:underline">${song.artist}</td>
                        <td class="p-3 text-[var(--md-on-surface-variant)] hidden md:table-cell cursor-pointer hover:underline">${song.album}</td>
                        <td class="p-3 text-[var(--md-on-surface-variant)] text-right">${formatTime(song.duration)}</td>
                        <td class="p-3 text-center w-12 rounded-r-lg">
                            <button class="options-btn p-1 rounded-full hover:bg-[var(--md-surface-variant)]">
                                <span class="material-symbols-outlined">more_vert</span>
                            </button>
                        </td>`;
                    
                    const playSongAction = () => {
                        currentQueue = songs;
                        const songIndexInQueue = songs.indexOf(song);
                        playAndRecordHistory(songIndexInQueue);
                    };

                    // Cells for playing the song
                    tr.children[0].onclick = playSongAction;
                    tr.children[1].onclick = playSongAction;
                    
                    // Cell for navigating to artist
                    tr.children[2].onclick = (e) => {
                        e.stopPropagation();
                        switchView('artist-detail', song.artist);
                    };

                    // Cell for navigating to album
                    tr.children[3].onclick = (e) => {
                        e.stopPropagation();
                        switchView('album-detail', song.album);
                    };
                    
                    tr.querySelector('.options-btn').onclick = (e) => { e.stopPropagation(); showContextMenu(e, songKey); };
                    
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody); return table;
            }
            function createMediaGrid(mediaItems, type) {
                if (mediaItems.length === 0) {
                    return document.createRange().createContextualFragment(`<div class="flex flex-col items-center justify-center h-full text-center text-[var(--md-on-surface-variant)] p-4"><span class="material-symbols-outlined text-7xl mb-4">${type === 'video' ? 'movie_off' : 'image_not_supported'}</span><h2 class="text-xl font-semibold mb-2 text-[var(--md-on-surface)]">No hay ${type === 'video' ? 'vídeos' : 'imágenes'}</h2><p>Esta vista no contiene archivos de este tipo.</p></div>`);
                }
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6';
                mediaItems.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'cursor-pointer group relative';
                    
                    const aspect = type === 'video' ? 'aspect-video' : 'aspect-square';
                    const icon = type === 'video' ? 'play_circle' : 'open_in_full';

                    el.innerHTML = `
                        <div class="relative w-full h-auto ${aspect}">
                            <img src="${item.picture}" onerror="this.src='${placeholderArt}'" class="w-full h-full rounded-xl shadow-lg group-hover:brightness-90 transition-all object-cover bg-slate-700">
                            <div class="absolute inset-0 flex items-center justify-center rounded-xl bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="material-symbols-outlined text-white text-5xl">${icon}</span>
                            </div>
                        </div>
                        <h3 class="font-semibold mt-2 truncate text-sm sm:text-base">${item.title}</h3>
                        ${item.duration ? `<p class="text-sm text-[var(--md-on-surface-variant)] truncate">${formatTime(item.duration)}</p>` : ''}
                    `;
                    
                    el.addEventListener('click', () => {
                        if (type === 'video') openVideoModal(item);
                        else openImageModal(item);
                    });
                    grid.appendChild(el);
                });
                return grid;
            }

            // --- MEDIA VIEWERS (MODALS) ---
            function openVideoModal(videoItem) {
                audioPlayer.pause();
                videoPlayerElement.src = videoItem.url;
                showModal(videoModal);
                videoPlayerElement.play();
            }
            closeVideoBtn.addEventListener('click', () => {
                videoPlayerElement.pause();
                videoPlayerElement.src = '';
                hideModal(videoModal);
            });
             function openImageModal(imageItem) {
                imageViewerElement.src = imageItem.url;
                showModal(imageModal);
            }
            closeImageBtn.addEventListener('click', () => {
                imageViewerElement.src = '';
                hideModal(imageModal);
            });
            
            // --- SEARCH ---
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                if (currentView.includes('song') || currentView.includes('detail')) {
                    document.querySelectorAll('.song-item').forEach(item => { const title = item.children[1].textContent.toLowerCase(); const artist = item.children[2].textContent.toLowerCase(); item.style.display = (title.includes(term) || artist.includes(term)) ? '' : 'none'; });
                } else if (currentView === 'albums') {
                    document.querySelectorAll('.album-grid-item').forEach(item => { const title = item.children[1].textContent.toLowerCase(); const artist = item.children[2].textContent.toLowerCase(); item.style.display = (title.includes(term) || artist.includes(term)) ? '' : 'none'; });
                } else if (currentView === 'artists') {
                     document.querySelectorAll('.artist-list-item').forEach(item => { const name = item.children[1].textContent.toLowerCase(); item.style.display = name.includes(term) ? '' : 'none'; });
                }
            });

            // --- MODALS & CONTEXT MENU ---
            const showModal = (modal) => modal.classList.add('flex', 'items-center', 'justify-center') || modal.classList.remove('hidden');
            const hideModal = (modal) => modal.classList.add('hidden') || modal.classList.remove('flex', 'items-center', 'justify-center');
            
            cancelPlaylistBtn.addEventListener('click', () => hideModal(createPlaylistModal));
            savePlaylistBtn.addEventListener('click', () => {
                const name = playlistNameInput.value.trim();
                if (name && !playlists[name]) { playlists[name] = { name: name, songs: [] }; savePlaylists(); hideModal(createPlaylistModal); if (currentView === 'playlists') { switchView('playlists'); }
                } else if (playlists[name]) { alert("Ya existe una playlist con este nombre."); }
            });
            cancelAddToPlaylistBtn.addEventListener('click', () => hideModal(addToPlaylistModal));
            cancelDeleteBtn.addEventListener('click', () => hideModal(deletePlaylistModal));
            confirmDeleteBtn.addEventListener('click', () => {
                if (playlistToDelete) {
                    deletePlaylist(playlistToDelete);
                }
            });

            function showContextMenu(e, songKey) {
                e.preventDefault();
                const item = mediaMap.get(songKey);
                if (!item || item.type !== 'audio') return;

                const isPlaylistDetailView = currentView === 'playlist-detail';
                let menuItems = `<div id="add-to-playlist-action" class="px-4 py-2 hover:bg-[var(--md-surface-variant)] rounded-lg cursor-pointer">Añadir a playlist...</div>`;
                if (isPlaylistDetailView) { menuItems += `<div id="remove-from-playlist-action" class="px-4 py-2 hover:bg-[var(--md-surface-variant)] rounded-lg cursor-pointer text-red-500">Eliminar de la playlist</div>`; }
                contextMenu.innerHTML = menuItems;
                
                contextMenu.classList.remove('hidden');
                const menuWidth = contextMenu.offsetWidth;
                const menuHeight = contextMenu.offsetHeight;

                let x = e.clientX;
                let y = e.clientY;

                if (x + menuWidth > window.innerWidth) x = window.innerWidth - menuWidth - 5; 
                if (y + menuHeight > window.innerHeight) y = window.innerHeight - menuHeight - 5; 

                contextMenu.style.top = `${y}px`;
                contextMenu.style.left = `${x}px`;

                document.getElementById('add-to-playlist-action').addEventListener('click', () => openAddToPlaylistModal(songKey));
                if (isPlaylistDetailView) { document.getElementById('remove-from-playlist-action').addEventListener('click', () => removeSongFromPlaylist(songKey, headerTitle.textContent)); }
            }

            function showContextMenuForAlbum(e, album) {
                contextMenu.innerHTML = `<div id="change-cover-action" class="px-4 py-2 hover:bg-[var(--md-surface-variant)] rounded-lg cursor-pointer">Cambiar portada</div>`;
                
                contextMenu.classList.remove('hidden');
                const menuWidth = contextMenu.offsetWidth;
                const menuHeight = contextMenu.offsetHeight;
                let x = e.clientX, y = e.clientY;
                if (x + menuWidth > window.innerWidth) x = window.innerWidth - menuWidth - 5;
                if (y + menuHeight > window.innerHeight) y = window.innerHeight - menuHeight - 5;
                contextMenu.style.top = `${y}px`;
                contextMenu.style.left = `${x}px`;

                contextMenu.querySelector('#change-cover-action').addEventListener('click', () => {
                    coverArtInput.click();
                    hideContextMenu();
                });
            }

            const hideContextMenu = () => { contextMenu.classList.add('hidden'); };
            window.addEventListener('click', hideContextMenu);
            window.addEventListener('contextmenu', (e) => { 
                if (!e.target.closest('.song-item') && !e.target.closest('.album-grid-item')) {
                    hideContextMenu();
                }
            });

            function openAddToPlaylistModal(songKey) {
                playlistSelectionList.innerHTML = ''; const playlistNames = Object.keys(playlists).sort();
                if (playlistNames.length === 0) { playlistSelectionList.innerHTML = '<p class="text-sm text-[var(--md-on-surface-variant)]">No tienes playlists. ¡Crea una primero!</p>'; } 
                else { playlistNames.forEach(name => {
                    const item = document.createElement('div'); item.className = 'p-3 rounded-lg hover:bg-[var(--md-surface-variant)] cursor-pointer'; item.textContent = name;
                    item.onclick = () => { addSongToPlaylist(songKey, name); hideModal(addToPlaylistModal); };
                    playlistSelectionList.appendChild(item);
                });}
                showModal(addToPlaylistModal);
            }
            function addSongToPlaylist(songKey, playlistName) {
                if (!playlists[playlistName] || !songKey) return;
                if (!playlists[playlistName].songs.includes(songKey)) { playlists[playlistName].songs.push(songKey); savePlaylists(); }
            }
            function removeSongFromPlaylist(songKey, playlistName) {
                if (!playlists[playlistName] || !songKey) return;
                playlists[playlistName].songs = playlists[playlistName].songs.filter(key => key !== songKey);
                savePlaylists(); switchView('playlist-detail', playlistName);
            }
            function openDeletePlaylistModal(playlistName) {
                playlistToDelete = playlistName;
                deletePlaylistText.textContent = `¿Estás seguro de que quieres eliminar la playlist "${playlistName}"? Esta acción no se puede deshacer.`;
                showModal(deletePlaylistModal);
            }
            function deletePlaylist(playlistName) {
                if (playlists[playlistName]) {
                    delete playlists[playlistName];
                    savePlaylists();
                }
                hideModal(deletePlaylistModal);
                if (currentView === 'playlists' || (currentView === 'playlist-detail' && playlistName === headerTitle.textContent)) {
                    switchView('playlists');
                }
                playlistToDelete = null;
            }
            
            // --- PRESENTATION API (CAST) ---
            if ('presentation' in navigator) {
                try {
                    const receiverUrl = window.location.href.split('?')[0] + '?presentation=true';
                    presentationRequest = new PresentationRequest([receiverUrl]);

                    navigator.presentation.defaultRequest = presentationRequest;

                    presentationRequest.getAvailability()
                        .then(availability => {
                            castBtn.style.display = availability.value ? 'block' : 'none';
                            availability.onchange = () => {
                                castBtn.style.display = availability.value ? 'block' : 'none';
                            };
                        })
                        .catch(() => {
                            castBtn.style.display = 'none';
                        });

                    castBtn.addEventListener('click', () => {
                        if (presentationConnection) {
                            presentationConnection.terminate();
                        } else {
                            startPresentation();
                        }
                    });
                } catch(error) {
                    if (error.name === 'SecurityError') {
                        console.warn('La API de Presentación (Cast) está bloqueada en este entorno.');
                        castBtn.style.display = 'none';
                    } else {
                        console.error('Error al inicializar la API de Presentación:', error);
                        castBtn.style.display = 'none';
                    }
                }
            } else {
                castBtn.style.display = 'none';
            }

            function startPresentation() {
                presentationRequest.start()
                    .then(connection => {
                        handleControllerConnection(connection);
                    })
                    .catch(error => {
                        console.error('Error al iniciar la presentación:', error);
                    });
            }
            
            function handleControllerConnection(connection) {
                presentationConnection = connection;
                castBtn.classList.add('text-[var(--md-primary)]'); // Indicate connected state
                
                presentationConnection.onclose = () => {
                    presentationConnection = null;
                    castBtn.classList.remove('text-[var(--md-primary)]');
                };
                presentationConnection.onterminate = () => {
                    presentationConnection = null;
                    castBtn.classList.remove('text-[var(--md-primary)]');
                };

                if (isPlaying) {
                     sendPresentationData({ type: 'lyricsUpdate', lyricsData: lyricsData, message: 'Cargando letra...'});
                }
            }

            function sendPresentationData(data) {
                if (presentationConnection && presentationConnection.state === 'connected') {
                    presentationConnection.send(JSON.stringify(data));
                }
            }

            // --- KARAOKE FUNCTIONS ---
            async function fetchLyrics(artist, title) {
                if (lyricsRequestController) lyricsRequestController.abort();
                lyricsRequestController = new AbortController();
                const { signal } = lyricsRequestController;
                try {
                    const lrcUrl = `https://lrclib.net/api/get?artist_name=${encodeURIComponent(artist)}&track_name=${encodeURIComponent(title)}`;
                    const lrcResponse = await fetch(lrcUrl, { signal });
                    if (lrcResponse.ok) {
                        const lrcData = await lrcResponse.json();
                        if (lrcData && lrcData.syncedLyrics) return { type: 'lrc', content: lrcData.syncedLyrics };
                    }
                    const plainUrl = `https://api.lyrics.ovh/v1/${encodeURIComponent(artist)}/${encodeURIComponent(title)}`;
                    const plainResponse = await fetch(plainUrl, { signal });
                    if (!plainResponse.ok) return null;
                    const plainData = await plainResponse.json();
                    return { type: 'plain', content: plainData.lyrics };

                } catch (error) {
                    if (error.name !== 'AbortError') console.error('Error al buscar las letras:', error);
                    return null;
                }
            }

            function parseAndPrepareLyrics(lyricsResult, duration) {
                if (!lyricsResult || !lyricsResult.content || !duration) return [];
                if (lyricsResult.type === 'lrc') {
                    const lines = lyricsResult.content.split('\n');
                    const lrcRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/;
                    const lyricsWithTimes = [];
                    lines.forEach(line => {
                        const match = line.match(lrcRegex);
                        if (match) {
                            const minutes = parseInt(match[1], 10), seconds = parseInt(match[2], 10), milliseconds = parseInt(match[3].padEnd(3, '0'), 10), text = match[4].trim();
                            if (text) lyricsWithTimes.push({ startTime: (minutes * 60) + seconds + (milliseconds / 1000), text });
                        }
                    });
                    lyricsWithTimes.sort((a, b) => a.startTime - b.startTime);
                    lyricsWithTimes.forEach((line, i) => { line.endTime = (i < lyricsWithTimes.length - 1) ? lyricsWithTimes[i + 1].startTime : duration; });
                    return lyricsWithTimes;
                }
                if (lyricsResult.type === 'plain') {
                    const lines = lyricsResult.content.split('\n').map(l => l.trim()).filter(Boolean);
                    let totalWords = 0; lines.forEach(l => { totalWords += l.split(' ').length; });
                    if (totalWords === 0) return [];
                    const timePerWord = duration / totalWords; let accumulatedTime = 0;
                    const lyricsWithTimes = lines.map(line => {
                        const wordCount = line.split(' ').length, lineData = { text: line, startTime: accumulatedTime };
                        accumulatedTime += wordCount * timePerWord; return lineData;
                    });
                    lyricsWithTimes.forEach((line, i) => { line.endTime = (i < lyricsWithTimes.length - 1) ? lyricsWithTimes[i+1].startTime : duration; });
                    return lyricsWithTimes;
                }
                return [];
            }

            async function displayLyricsForCurrentSong() {
                const song = currentQueue[currentQueueIndex]; if (!song) return;
                lyricsContainer.innerHTML = `<div class="text-white animate-pulse">Buscando letras...</div>`;
                sendPresentationData({type: 'lyricsUpdate', message: 'Buscando letras...'});
                lyricsData = null; currentLyricIndex = -1;
                const lyricsResult = await fetchLyrics(song.artist, song.title);
                if (lyricsResult && lyricsResult.content) {
                    lyricsData = parseAndPrepareLyrics(lyricsResult, audioPlayer.duration);
                    if(lyricsData && lyricsData.length > 0) {
                        lyricsContainer.innerHTML = '';
                        lyricsData.forEach((line, index) => {
                            const p = document.createElement('p'); p.className = 'lyric-line p-2'; p.id = `lyric-line-${index}`;
                            const span = document.createElement('span'); span.textContent = line.text; p.appendChild(span); lyricsContainer.appendChild(p);
                        });
                        if (lyricsResult.type === 'plain') {
                            const notice = document.createElement('p'); notice.className = 'text-xs text-gray-400 mt-4 lyric-line'; notice.textContent = 'Sincronización de letras aproximada.'; lyricsContainer.appendChild(notice);
                        }
                        sendPresentationData({type: 'lyricsUpdate', lyricsData});
                    } else {
                        const msg = 'No se pudieron procesar las letras.';
                        lyricsContainer.innerHTML = `<div class="text-white">${msg}</div>`;
                        sendPresentationData({type: 'lyricsUpdate', message: msg});
                    }
                } else {
                    const msg = 'Letras no encontradas.';
                    lyricsContainer.innerHTML = `<div class="text-white">${msg}</div>`;
                    sendPresentationData({type: 'lyricsUpdate', message: msg});
                }
            }

            function updateKaraokeHighlight() {
                if (!lyricsData || lyricsData.length === 0) return;
                const currentTime = audioPlayer.currentTime;
                let newLyricIndex = -1;
                for (let i = 0; i < lyricsData.length; i++) {
                    if (currentTime >= lyricsData[i].startTime && currentTime < lyricsData[i].endTime) { newLyricIndex = i; break; }
                }
                if (newLyricIndex !== currentLyricIndex) {
                    if(currentLyricIndex > -1) { const oldLine = document.getElementById(`lyric-line-${currentLyricIndex}`); if(oldLine) { oldLine.classList.remove('active'); oldLine.classList.add('past'); } }
                    if(newLyricIndex > -1) { const newLine = document.getElementById(`lyric-line-${newLyricIndex}`); if(newLine) { newLine.classList.remove('past'); newLine.classList.add('active'); if(!karaokeModal.classList.contains('hidden')) newLine.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
                    currentLyricIndex = newLyricIndex;
                }
                let progress = 0;
                if (currentLyricIndex > -1) {
                    const activeLineEl = document.getElementById(`lyric-line-${currentLyricIndex}`), lineData = lyricsData[currentLyricIndex];
                    if (activeLineEl && lineData) {
                        const lineDuration = lineData.endTime - lineData.startTime;
                        if (lineDuration > 0.1) {
                            progress = Math.max(0, Math.min(100, ((currentTime - lineData.startTime) / lineDuration) * 100));
                            activeLineEl.querySelector('span').style.setProperty('--word-progress', `${progress}%`);
                        } else {
                            progress = 100;
                            activeLineEl.querySelector('span').style.setProperty('--word-progress', `100%`);
                        }
                    }
                }
                if (presentationConnection) sendPresentationData({type: 'highlightUpdate', currentIndex: currentLyricIndex, progress});
            }
            
            async function toggleKaraokeView() {
                const isHidden = karaokeModal.classList.contains('hidden');
                if (isHidden) {
                    karaokeModal.classList.remove('hidden');
                    if (currentQueueIndex !== -1) { await displayLyricsForCurrentSong(); updateKaraokeHighlight(); } 
                    else { lyricsContainer.innerHTML = `<div class="text-white">Reproduce una canción para ver la letra.</div>`; }
                } else { karaokeModal.classList.add('hidden'); }
            }
            
            karaokeBtn.addEventListener('click', toggleKaraokeView);
            npLyricsBtn.addEventListener('click', toggleKaraokeView); // Link NP lyrics button
            closeKaraokeBtn.addEventListener('click', toggleKaraokeView);

            // --- PLAYBACK CONTROLS ---
            function playAndRecordHistory(index) {
                playSong(index);
                const song = currentQueue[index]; if (!song) return;
                const songKey = `${song.title}|${song.artist}|${song.album}`.toLowerCase().trim();
                const globalIndex = allMedia.findIndex(s => { const sKey = `${s.title}|${s.artist || ''}|${s.album || ''}`.toLowerCase().trim(); return sKey === songKey; });
                if (historyIndex < playHistory.length - 1) playHistory.splice(historyIndex + 1);
                if (playHistory[playHistory.length - 1] !== globalIndex) playHistory.push(globalIndex);
                historyIndex = playHistory.length - 1;
            }
            const toggleActiveButton = (btn, state) => {
                btn.classList.toggle('text-white/80', !state);
                btn.classList.toggle('text-white', state);
                btn.classList.toggle('bg-white/10', state); // Add subtle background for active state in NP view
                btn.classList.toggle('active-control', state); // Use class for dynamic color
                btn.querySelector('.material-symbols-outlined').style.fontVariationSettings = state ? "'FILL' 1, 'wght' 400" : "'FILL' 0, 'wght' 300";
            };
             // Modified toggle for footer buttons to match original style
            const toggleFooterActiveButton = (btn, state) => {
                btn.classList.toggle('text-[var(--md-primary)]', state);
                btn.classList.toggle('bg-[var(--md-primary-container)]', state);
                btn.classList.toggle('text-[var(--md-on-surface-variant)]', !state);
                btn.classList.toggle('hover:bg-[var(--md-surface-variant)]', !state);
                btn.querySelector('.material-symbols-outlined').style.fontVariationSettings = state ? "'FILL' 1, 'wght' 400" : "'FILL' 0, 'wght' 300";
            };

            shuffleBtn.onclick = () => { isShuffle = !isShuffle; syncShuffleRepeatState(); };
            npShuffleBtn.onclick = shuffleBtn.onclick;

            repeatBtn.onclick = () => { isRepeat = !isRepeat; syncShuffleRepeatState(); };
            npRepeatBtn.onclick = repeatBtn.onclick;
            
            function playSong(index) {
                if (!currentQueue || index < 0 || index >= currentQueue.length) return;
                currentQueueIndex = index; const song = currentQueue[currentQueueIndex];
                logSongPlayback(song);
                lyricsData = null; 
                currentAlbumArt.src = song.picture; // This now triggers onload for ColorThief
                
                // Add crossOrigin attribute ONLY IF fetching from external URL like iTunes
                // If it's always a local blob URL, this is not needed and might cause issues.
                // currentAlbumArt.crossOrigin = "Anonymous"; 

                currentSongTitle.textContent = song.title; 
                currentSongArtist.textContent = song.artist;
                audioPlayer.src = song.url; // This will trigger the 'loadedmetadata' event listener
                 // Update Now Playing view if it's open
                 if (!nowPlayingView.classList.contains('hidden')) {
                     openNowPlayingView(); // Re-populate NP view with new song info
                 }
            }

            // Moved ColorThief logic to onload event of currentAlbumArt
            currentAlbumArt.onload = () => {
                try {
                    // Make sure the image is fully loaded and has dimensions
                    if (currentAlbumArt.complete && currentAlbumArt.naturalWidth > 0) {
                        const colorThief = new ColorThief();
                        const dominantColor = colorThief.getColor(currentAlbumArt);
                        document.documentElement.style.setProperty('--dynamic-accent-color', `rgb(${dominantColor.join(',')})`);
                        // Update background dynamically if NP view is visible or about to be
                         nowPlayingBg.style.backgroundImage = `url(${currentAlbumArt.src})`;
                    } else {
                         // Image not ready, use default
                         resetDynamicColor();
                    }
                } catch (e) {
                    console.error("Error getting color from album art:", e);
                    resetDynamicColor();
                }
            };
            currentAlbumArt.onerror = () => {
                 resetDynamicColor();
                 npAlbumArt.src = placeholderArt; // Also update NP view placeholder
            };

             function resetDynamicColor() {
                 document.documentElement.style.setProperty('--dynamic-accent-color', 'var(--md-primary)');
                 nowPlayingBg.style.backgroundImage = `linear-gradient(to bottom, var(--md-primary), var(--md-surface-1))`;
             }


            function togglePlayPause() {
                if (isPlaying) audioPlayer.pause(); 
                else { if (currentQueueIndex === -1 && allMedia.length > 0) { currentQueue = (folders[activeFolderName] || allMedia).filter(i => i.type==='audio'); playAndRecordHistory(0); } else if (currentQueueIndex !== -1) audioPlayer.play(); }
            }
            function playNext() {
                if (currentQueue.length === 0) return;
                if (isShuffle) { let randomIndex; if (currentQueue.length > 1) { do { randomIndex = Math.floor(Math.random() * currentQueue.length); } while (randomIndex === currentQueueIndex); } else { randomIndex = 0; } playAndRecordHistory(randomIndex);
                } else { let newIndex = (currentQueueIndex + 1) % currentQueue.length; playAndRecordHistory(newIndex); }
            }
            function playPrev() {
                if (audioPlayer.currentTime > 3 || historyIndex <= 0) { audioPlayer.currentTime = 0; }
                else { historyIndex--; const mediaToPlay = allMedia[playHistory[historyIndex]]; const indexInQueue = currentQueue.indexOf(mediaToPlay); if (indexInQueue > -1) playSong(indexInQueue); else playPrev(); }
            }
            // Update both sets of play/pause icons
            function updatePlayPauseIcons() {
                playIcon.classList.toggle('hidden', isPlaying);
                pauseIcon.classList.toggle('hidden', !isPlaying);
                npPlayIcon.classList.toggle('hidden', isPlaying);
                npPauseIcon.classList.toggle('hidden', !isPlaying);
            }
            // Sync shuffle/repeat button states across both UIs
            function syncShuffleRepeatState() {
                toggleFooterActiveButton(shuffleBtn, isShuffle);
                toggleActiveButton(npShuffleBtn, isShuffle);
                toggleFooterActiveButton(repeatBtn, isRepeat);
                toggleActiveButton(npRepeatBtn, isRepeat);
            }
            
            // --- PROGRESS & VOLUME ---
            // Update both progress bars
            function updateProgress() {
                if (audioPlayer.duration) { 
                    const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    progressBar.style.width = `${progressPercent}%`; 
                    npProgressBar.style.width = `${progressPercent}%`; 
                    const currentTimeFormatted = formatTime(audioPlayer.currentTime);
                    const durationFormatted = formatTime(audioPlayer.duration);
                    currentTimeEl.textContent = currentTimeFormatted; 
                    npCurrentTime.textContent = currentTimeFormatted;
                    durationEl.textContent = durationFormatted;
                    npDuration.textContent = durationFormatted;
                    updateKaraokeHighlight();
                } else {
                    // Reset if no duration (e.g., before loading)
                    progressBar.style.width = '0%';
                    npProgressBar.style.width = '0%';
                    currentTimeEl.textContent = '0:00';
                    npCurrentTime.textContent = '0:00';
                    durationEl.textContent = '0:00';
                    npDuration.textContent = '0:00';
                }
            }
            // Set progress from either bar
            function setProgress(e, container) { 
                if (audioPlayer.duration) { 
                    const rect = container.getBoundingClientRect();
                    const offsetX = e.clientX - rect.left;
                    audioPlayer.currentTime = (offsetX / container.clientWidth) * audioPlayer.duration; 
                } 
            }
            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return '0:00'; const minutes = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            }

            // --- EVENT LISTENERS ---
            playPauseBtn.addEventListener('click', togglePlayPause);
            npPlayPauseBtn.addEventListener('click', togglePlayPause);
            nextBtn.addEventListener('click', playNext);
            npNextBtn.addEventListener('click', playNext);
            prevBtn.addEventListener('click', playPrev);
            npPrevBtn.addEventListener('click', playPrev);
            audioPlayer.addEventListener('timeupdate', updateProgress);

            audioPlayer.addEventListener('loadedmetadata', () => {
                updateProgress(); // Update duration display immediately
                // Now that we have duration, we can fetch lyrics
                if (!karaokeModal.classList.contains('hidden') || presentationConnection) {
                    displayLyricsForCurrentSong();
                }
                // And now we can safely play
                const playPromise = audioPlayer.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        // Ignore the abort error which is expected if the user skips songs quickly
                        if (error.name !== 'AbortError') {
                            console.error("Error al reproducir:", error);
                        }
                    });
                }
            });

            audioPlayer.addEventListener('ended', () => { if (isRepeat) { audioPlayer.currentTime = 0; audioPlayer.play(); } else { playNext(); } });
            progressBarContainer.addEventListener('click', (e) => setProgress(e, progressBarContainer));
            npProgressBarContainer.addEventListener('click', (e) => setProgress(e, npProgressBarContainer));
            audioPlayer.onplaying = () => { isPlaying = true; updatePlayPauseIcons(); };
            audioPlayer.onpause = () => { isPlaying = false; updatePlayPauseIcons(); };

            // --- VOLUME CONTROL ---
            function updateVolumeIcon() {
                if (audioPlayer.muted || audioPlayer.volume === 0) {
                    volumeIcon.textContent = 'volume_off';
                } else if (audioPlayer.volume < 0.5) {
                    volumeIcon.textContent = 'volume_down';
                } else {
                    volumeIcon.textContent = 'volume_up';
                }
            }

            volumeBtn.addEventListener('click', () => {
                audioPlayer.muted = !audioPlayer.muted;
            });

            volumeSlider.addEventListener('input', () => {
                audioPlayer.muted = false; // Sliding the volume should always unmute
                audioPlayer.volume = volumeSlider.value;
            });
            
            audioPlayer.addEventListener('volumechange', () => {
                if (audioPlayer.muted) {
                    volumeSlider.value = 0;
                } else {
                    volumeSlider.value = audioPlayer.volume;
                }
                updateVolumeIcon();
            });
            
            // Initial call to set icon correctly
            updateVolumeIcon();

            // --- HISTORY & CALENDAR FUNCTIONS ---
            function logSongPlayback(song) {
                if (!song) return;
                const now = new Date();
                const dateKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const songKey = `${song.title}|${song.artist}|${song.album}`.toLowerCase().trim();
                const record = { songKey, timestamp: now.getTime() };
                try {
                    const dayHistory = JSON.parse(localStorage.getItem(`history-${dateKey}`) || '[]');
                    dayHistory.unshift(record);
                    localStorage.setItem(`history-${dateKey}`, JSON.stringify(dayHistory));
                } catch (e) { console.error("Could not save playback history:", e); }
            }

            function renderCalendarView(date) {
                const container = document.createElement('div');
                container.id = 'calendar-view-container';

                const header = document.createElement('div');
                header.className = 'flex items-center justify-between p-2 mb-4';
                
                const monthYear = document.createElement('h3');
                monthYear.className = 'text-xl font-bold capitalize';
                monthYear.textContent = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

                const navButtons = document.createElement('div');
                navButtons.className = 'flex items-center space-x-2';

                const prevBtn = document.createElement('button');
                prevBtn.className = 'p-2 rounded-full hover:bg-[var(--md-surface-variant)]';
                prevBtn.innerHTML = `<span class="material-symbols-outlined">chevron_left</span>`;
                prevBtn.onclick = () => {
                    calendarDate.setMonth(calendarDate.getMonth() - 1);
                    switchView('history');
                };

                const nextBtn = document.createElement('button');
                nextBtn.className = 'p-2 rounded-full hover:bg-[var(--md-surface-variant)]';
                nextBtn.innerHTML = `<span class="material-symbols-outlined">chevron_right</span>`;
                nextBtn.onclick = () => {
                    calendarDate.setMonth(calendarDate.getMonth() + 1);
                    switchView('history');
                };

                navButtons.append(prevBtn, nextBtn);
                header.append(monthYear, navButtons);

                const calendarGrid = document.createElement('div');
                calendarGrid.className = 'grid grid-cols-7 gap-1 text-center';
                calendarGrid.id = 'calendar-grid';
                
                ['D', 'L', 'M', 'X', 'J', 'V', 'S'].forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'font-bold text-[var(--md-on-surface-variant)] text-sm py-2';
                    dayHeader.textContent = day;
                    calendarGrid.appendChild(dayHeader);
                });

                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let i = 0; i < firstDay; i++) calendarGrid.appendChild(document.createElement('div'));

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayCell = document.createElement('div');
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const hasHistory = localStorage.getItem(`history-${dateKey}`) !== null;
                    const hasEvents = calendarEvents[dateKey] && calendarEvents[dateKey].length > 0;

                    dayCell.className = 'p-2 rounded-full relative cursor-pointer hover:bg-[var(--md-surface-variant)] flex flex-col items-center justify-center aspect-square';
                    dayCell.onclick = () => showDayDetails(dateKey, dayCell);
                    
                    const dayNumber = document.createElement('span');
                    dayNumber.textContent = i;
                    dayCell.appendChild(dayNumber);
                    
                    if (hasHistory || hasEvents) {
                        const indicators = document.createElement('div');
                        indicators.className = 'flex items-center space-x-1 absolute bottom-2 left-1/2 -translate-x-1/2';
                        if (hasHistory) {
                            const historyIndicator = document.createElement('div');
                            historyIndicator.className = 'w-1.5 h-1.5 bg-[var(--md-primary)] rounded-full';
                            indicators.appendChild(historyIndicator);
                        }
                        if(hasEvents) {
                            const eventIndicator = document.createElement('div');
                            eventIndicator.className = 'w-1.5 h-1.5 bg-[var(--md-secondary)] rounded-full';
                            indicators.appendChild(eventIndicator);
                        }
                        dayCell.appendChild(indicators);
                    }
                    calendarGrid.appendChild(dayCell);
                }
                
                const detailsContainer = document.createElement('div');
                detailsContainer.id = 'day-details-container';
                detailsContainer.className = 'mt-6';

                container.append(header, calendarGrid, detailsContainer);
                return container;
            }

            function showDayDetails(dateKey, activeCell) {
                document.querySelectorAll('#calendar-grid > div').forEach(cell => cell.classList.remove('bg-[var(--md-primary-container)]', 'text-[var(--md-on-primary-container)]'));
                if (activeCell) activeCell.classList.add('bg-[var(--md-primary-container)]', 'text-[var(--md-on-primary-container)]');
                
                const detailsContainer = document.getElementById('day-details-container');
                detailsContainer.innerHTML = '';
                
                const [year, month, day] = dateKey.split('-');
                const headerText = `Resumen del ${day}/${month}/${year}`;
                
                // --- Events and Tasks Section ---
                const eventsSection = document.createElement('div');
                const eventsHeaderContainer = document.createElement('div');
                eventsHeaderContainer.className = 'flex justify-between items-center mb-2';
                const eventsHeader = document.createElement('h4');
                eventsHeader.className = 'text-lg font-bold';
                eventsHeader.textContent = `Eventos y Tareas`;
                const addEventBtn = document.createElement('button');
                addEventBtn.className = 'p-2 rounded-full hover:bg-[var(--md-surface-variant)]';
                addEventBtn.innerHTML = `<span class="material-symbols-outlined">add</span>`;
                addEventBtn.onclick = () => openEventModal(dateKey);
                eventsHeaderContainer.append(eventsHeader, addEventBtn);
                eventsSection.appendChild(eventsHeaderContainer);

                const dayEvents = calendarEvents[dateKey] || [];
                const eventsList = document.createElement('ul');
                eventsList.className = 'space-y-2 mb-6';
                if (dayEvents.length > 0) {
                    dayEvents.forEach(event => {
                        const li = document.createElement('li');
                        li.className = `task-item flex items-center justify-between p-3 rounded-lg ${event.completed ? 'bg-[var(--md-surface-variant)]/50' : 'bg-[var(--md-surface-variant)]'}`;
                        if(event.completed) li.classList.add('completed');

                        const content = document.createElement('div');
                        content.className = 'flex items-center overflow-hidden';
                        
                        if (event.type === 'task') {
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.checked = event.completed;
                            checkbox.className = 'w-5 h-5 mr-3 rounded accent-[var(--md-primary)] cursor-pointer';
                            checkbox.onchange = () => toggleTaskCompletion(dateKey, event.id);
                            content.appendChild(checkbox);
                        } else {
                            const icon = document.createElement('span');
                            icon.className = 'material-symbols-outlined mr-3 text-[var(--md-secondary)]';
                            icon.textContent = 'event';
                            content.appendChild(icon);
                        }

                        const label = document.createElement('label');
                        label.textContent = event.title;
                        label.className = 'font-semibold truncate cursor-pointer';
                        label.onclick = () => openEventModal(dateKey, event.id);
                        content.appendChild(label);
                        li.appendChild(content);

                        const buttons = document.createElement('div');
                        buttons.className = 'flex items-center';
                        const editBtn = document.createElement('button');
                        editBtn.className = 'p-1.5 rounded-full hover:bg-black/10 dark:hover:bg-white/10';
                        editBtn.innerHTML = `<span class="material-symbols-outlined text-base">edit</span>`;
                        editBtn.onclick = () => openEventModal(dateKey, event.id);
                        buttons.appendChild(editBtn);
                        li.appendChild(buttons);
                        
                        eventsList.appendChild(li);
                    });
                } else {
                    eventsList.innerHTML = `<p class="text-center text-sm text-[var(--md-on-surface-variant)] py-4">No hay eventos ni tareas para este día.</p>`;
                }
                eventsSection.appendChild(eventsList);
                detailsContainer.appendChild(eventsSection);

                // --- Music History Section ---
                const dayHistory = JSON.parse(localStorage.getItem(`history-${dateKey}`) || '[]');
                if (dayHistory.length > 0) {
                    const historySection = document.createElement('div');
                    const historyHeader = document.createElement('h4');
                    historyHeader.className = 'text-lg font-bold mb-2';
                    historyHeader.textContent = `Historial de Reproducción`;
                    historySection.appendChild(historyHeader);

                    const list = document.createElement('ul');
                    list.className = 'space-y-2';
                    dayHistory.forEach(record => {
                        const song = mediaMap.get(record.songKey);
                        if (!song) return;
                        const time = new Date(record.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                        const li = document.createElement('li');
                        li.className = 'flex items-center justify-between p-3 bg-[var(--md-surface-variant)] rounded-lg';
                        li.innerHTML = `
                            <div class="flex items-center overflow-hidden">
                                <img src="${song.picture}" class="w-10 h-10 rounded-md object-cover mr-3">
                                <div class="overflow-hidden">
                                    <p class="font-semibold truncate">${song.title}</p>
                                    <p class="text-sm text-[var(--md-on-surface-variant)] truncate">${song.artist}</p>
                                </div>
                            </div>
                            <span class="text-sm text-[var(--md-on-surface-variant)]">${time}</span>
                        `;
                        list.appendChild(li);
                    });
                    historySection.appendChild(list);
                    detailsContainer.appendChild(historySection);
                }
            }
            
            // --- Calendar Event Modal Logic ---
            let currentEditing = { dateKey: null, eventId: null };
            function openEventModal(dateKey, eventId = null) {
                currentEditing = { dateKey, eventId };
                const eventData = eventId ? calendarEvents[dateKey].find(e => e.id === eventId) : null;

                eventModalTitle.textContent = eventData ? 'Editar' : 'Añadir';
                eventTitleInput.value = eventData ? eventData.title : '';
                document.querySelector(`input[name="eventType"][value="${eventData?.type || 'event'}"]`).checked = true;

                deleteEventBtn.style.display = eventData ? 'block' : 'none';
                showModal(eventModal);
                eventTitleInput.focus();
            }

            cancelEventBtn.addEventListener('click', () => hideModal(eventModal));

            saveEventBtn.addEventListener('click', () => {
                const title = eventTitleInput.value.trim();
                if (!title) return;

                const { dateKey, eventId } = currentEditing;
                const type = document.querySelector('input[name="eventType"]:checked').value;
                if (!calendarEvents[dateKey]) calendarEvents[dateKey] = [];

                if (eventId) { // Editing existing
                    const eventIndex = calendarEvents[dateKey].findIndex(e => e.id === eventId);
                    if (eventIndex > -1) {
                        calendarEvents[dateKey][eventIndex].title = title;
                        calendarEvents[dateKey][eventIndex].type = type;
                    }
                } else { // Creating new
                    const newEvent = { id: Date.now(), title, type, completed: false };
                    calendarEvents[dateKey].push(newEvent);
                }

                saveCalendarEvents();
                hideModal(eventModal);
                switchView('history'); // Re-render calendar to show new indicators
                // A small delay to allow the view to re-render before showing details
                setTimeout(() => {
                  const activeCell = Array.from(document.querySelectorAll('#calendar-grid > div')).find(cell => {
                    const day = cell.querySelector('span')?.textContent;
                    if (!day) return false;
                    const expectedDateKey = `${calendarDate.getFullYear()}-${String(calendarDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    return expectedDateKey === dateKey;
                  });
                  showDayDetails(dateKey, activeCell);
                }, 100);
            });
            
            deleteEventBtn.addEventListener('click', () => {
                const { dateKey, eventId } = currentEditing;
                if (dateKey && eventId) {
                    calendarEvents[dateKey] = calendarEvents[dateKey].filter(e => e.id !== eventId);
                    if (calendarEvents[dateKey].length === 0) delete calendarEvents[dateKey];
                    saveCalendarEvents();
                    hideModal(eventModal);
                    switchView('history');
                }
            });

            function toggleTaskCompletion(dateKey, eventId) {
                const eventIndex = calendarEvents[dateKey].findIndex(e => e.id === eventId);
                if (eventIndex > -1) {
                    calendarEvents[dateKey][eventIndex].completed = !calendarEvents[dateKey][eventIndex].completed;
                    saveCalendarEvents();
                    const activeCell = document.querySelector('#calendar-grid .bg-\\[var\\(--md-primary-container\\)\\]');
                    showDayDetails(dateKey, activeCell); // Refresh details view
                }
            }
            
            coverArtInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file || !albumToEdit) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const dataUrl = event.target.result;
                    const targetAlbum = Object.values(albums).find(a => a.title === albumToEdit);
                    if (!targetAlbum) return;

                    const albumKey = `${targetAlbum.artist}|${targetAlbum.title}`.toLowerCase().trim();
                    saveCustomCover(albumKey, dataUrl);

                    // Update all related song objects in memory
                    targetAlbum.songs.forEach(song => {
                        song.picture = dataUrl;
                    });

                    // Update the main album object in memory
                    targetAlbum.picture = dataUrl;

                    // If currently playing a song from this album, update the player UI
                    if (currentQueueIndex > -1) {
                        const currentSong = currentQueue[currentQueueIndex];
                        if (currentSong.album === albumToEdit) {
                            currentAlbumArt.src = dataUrl;
                        }
                    }

                    // Refresh the view to show the new cover
                    if (currentView === 'albums') {
                        renderAlbumGrid();
                    }
                    
                    // Reset for next time
                    albumToEdit = null;
                    coverArtInput.value = ''; // Allow selecting the same file again
                };
                reader.readAsDataURL(file);
            });

            // --- Now Playing View Logic ---
            function openNowPlayingView() {
                if (currentQueueIndex < 0) return; // Don't open if nothing is playing

                const song = currentQueue[currentQueueIndex];
                npAlbumArt.src = song.picture;
                npTitle.textContent = song.title;
                npArtist.textContent = song.artist;
                nowPlayingBg.style.backgroundImage = `url(${song.picture})`; // Update bg immediately

                // Ensure dynamic color is set (in case image was cached and onload didn't fire)
                if (currentAlbumArt.complete && currentAlbumArt.src === song.picture && currentAlbumArt.naturalWidth > 0) {
                     try {
                          // Make sure the image is usable by ColorThief
                          const imgElementForColor = new Image();
                          imgElementForColor.crossOrigin = "Anonymous"; // Needed if fetching external images
                          imgElementForColor.src = currentAlbumArt.src;
                          imgElementForColor.onload = () => {
                             const colorThief = new ColorThief();
                             const dominantColor = colorThief.getColor(imgElementForColor);
                             document.documentElement.style.setProperty('--dynamic-accent-color', `rgb(${dominantColor.join(',')})`);
                          }
                          imgElementForColor.onerror = () => resetDynamicColor(); // Fallback on error
                     } catch (e) { console.error("Error setting up ColorThief:", e); resetDynamicColor(); }
                } else if (!currentAlbumArt.complete) {
                    // If image wasn't loaded yet, rely on the onload handler
                     resetDynamicColor(); // Use default until loaded
                } else {
                     resetDynamicColor(); // Use default if image is broken or placeholder
                }

                syncShuffleRepeatState();
                updatePlayPauseIcons();
                updateProgress(); // Update progress bar immediately

                nowPlayingView.classList.remove('hidden', 'translate-y-full', 'opacity-0');
                nowPlayingView.classList.add('flex', 'flex-col'); // Make sure it's flex
            }

            function closeNowPlayingView() {
                nowPlayingView.classList.add('translate-y-full', 'opacity-0');
                // Hide after transition ends
                setTimeout(() => {
                    nowPlayingView.classList.add('hidden');
                    nowPlayingView.classList.remove('flex', 'flex-col');
                    closeQueuePanel(); // Ensure queue panel is closed when NP view is closed
                }, 300); // Match duration in CSS
            }

            currentAlbumArt.addEventListener('click', openNowPlayingView);
            closeNowPlayingBtn.addEventListener('click', closeNowPlayingView);
            npLyricsBtn.addEventListener('click', () => {
                toggleKaraokeView();
                // Optionally close NP view when opening karaoke, or keep it open?
                // closeNowPlayingView(); 
            });

            // --- Queue Panel Logic ---
            function renderQueue() {
                queueList.innerHTML = '';
                if (!currentQueue || currentQueue.length === 0) {
                    queueList.innerHTML = '<li class="p-4 text-center text-[var(--md-on-surface-variant)]">La cola está vacía.</li>';
                    return;
                }

                currentQueue.forEach((song, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center p-2 rounded-lg hover:bg-[var(--md-surface-variant)] cursor-pointer';
                    li.dataset.index = index; // Store original index if needed, or use for direct playback
                    
                    if (index === currentQueueIndex) {
                        li.classList.add('playing');
                    }

                    li.innerHTML = `
                        <img src="${song.picture}" onerror="this.src='${placeholderArt}'" class="w-10 h-10 rounded-md object-cover mr-3">
                        <div class="flex-1 overflow-hidden">
                            <p class="font-semibold truncate">${song.title}</p>
                            <p class="text-sm text-[var(--md-on-surface-variant)] truncate">${song.artist}</p>
                        </div>
                        <span class="material-symbols-outlined drag-handle text-[var(--md-on-surface-variant)] ml-2">drag_handle</span>
                    `;
                    // Play song if clicked (but not on the handle)
                    li.addEventListener('click', (e) => {
                         if (!e.target.classList.contains('drag-handle') && !e.target.parentElement.classList.contains('drag-handle')) { // Check parent too
                           // Find the actual index in the potentially reordered queue based on song object
                           const clickedSongIndex = currentQueue.findIndex(s => s.url === song.url); // Use URL as unique ID
                           if (clickedSongIndex !== -1) {
                               playAndRecordHistory(clickedSongIndex);
                           }
                           // Optionally close queue panel after selection?
                            closeQueuePanel();
                         }
                    });
                    queueList.appendChild(li);
                });

                 // Scroll the currently playing item into view if the list is long
                 const playingItem = queueList.querySelector('.playing');
                 if (playingItem) {
                     playingItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                 }
            }

            function openQueuePanel() {
                renderQueue();
                queuePanel.classList.remove('translate-x-full');
            }

            function closeQueuePanel() {
                queuePanel.classList.add('translate-x-full');
            }

            npQueueBtn.addEventListener('click', openQueuePanel);
            closeQueueBtn.addEventListener('click', closeQueuePanel);

            // Initialize SortableJS
             if (!sortableQueue) {
                sortableQueue = new Sortable(queueList, {
                    animation: 150,
                    handle: '.drag-handle', // Specify the drag handle
                    onEnd: function (evt) {
                        const { oldIndex, newIndex } = evt;
                        if (oldIndex === newIndex) return;

                        // Find the song object that *was* playing before the move
                        const currentlyPlayingSong = currentQueue[currentQueueIndex];

                        // Move the item in the actual currentQueue array
                        const [movedItem] = currentQueue.splice(oldIndex, 1);
                        currentQueue.splice(newIndex, 0, movedItem);

                        // Find the *new* index of the currently playing song object
                        currentQueueIndex = currentQueue.findIndex(song => song === currentlyPlayingSong);

                        // Re-render the list visually to update highlighting and order
                        // No need to call renderQueue immediately, Sortable updates the DOM.
                        // We only need to ensure the 'playing' class is correct after potential index change.
                         // Update data-index attributes and playing class
                         Array.from(queueList.children).forEach((li, idx) => {
                             li.dataset.index = idx;
                             li.classList.toggle('playing', idx === currentQueueIndex);
                         });

                    }
                });
             }

        }); // End DOMContentLoaded for player logic
    
    </script>
</body>
</html>

